<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TERESITAPP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link
    rel="icon"
    type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='80'%3Eüëµüèª%3C/text%3E%3C/svg%3E"
  />

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #222;
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      font-size: 1.4rem;
      margin: 0 0 4px;
      text-align: center;
    }

    .subtitle {
      font-size: 0.9rem;
      text-align: center;
      color: #666;
      margin-bottom: 8px;
    }

    .today-label {
      text-align: center;
      font-size: 0.8rem;
      color: #777;
      margin-bottom: 12px;
    }

    .familia-banner {
      text-align: center;
      font-size: 0.8rem;
      color: #003f8c;
      margin-bottom: 4px;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    }

    .card h2 {
      font-size: 1rem;
      margin: 0 0 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
    }

    .row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 8px;
    }

    label {
      font-size: 0.85rem;
      font-weight: 500;
    }

    input[type="date"],
    select,
    input[type="number"],
    input[type="text"],
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
      font-family: inherit;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .two-cols {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .checkbox-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 10px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
    }

    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .status-pill {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eee;
      color: #444;
      white-space: nowrap;
    }

    .status-ok {
      background: #d4f5dd;
      color: #19692c;
    }

    .status-pending {
      background: #ffe7c7;
      color: #8a4b00;
    }
    
    .status-danger {
      background: #ffe5e5;
      color: #a00000;
    }

    .dashboard-grid {
        display: flex;
        gap: 8px;
        flex-wrap: wrap; 
        margin-bottom: 4px;
    }

    .small-text {
      font-size: 0.8rem;
      color: #666;
    }

    .footer-info {
      text-align: center;
      font-size: 0.75rem;
      color: #999;
      margin-top: 8px;
    }

    .saved-message {
      font-size: 0.8rem;
      color: #19692c;
      text-align: right;
      min-height: 1em;
    }

    button.reset-btn {
      width: 100%;
      margin-top: 6px;
      padding: 8px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      background: #ffe5e5;
      color: #a00000;
      cursor: pointer;
    }

    button.reset-btn:active {
      opacity: 0.8;
    }

    button.export-btn {
      width: 100%;
      margin-top: 8px;
      padding: 8px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      background: #e6f0ff;
      color: #003f8c;
      cursor: pointer;
    }

    button.export-btn:active {
      opacity: 0.85;
    }

    .small-chip {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #f5f5f5;
      cursor: pointer;
    }

    .small-chip.secondary {
      background: #fff7e6;
      border-color: #f0c36b;
      color: #8a4b00;
    }

    /* Historial */
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 260px;
      overflow-y: auto;
    }

    .history-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #eee;
      background: #fafafa;
      font-size: 0.8rem;
      position: relative;
    }

    .history-item-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .history-title {
      font-weight: 600;
    }

    .history-meta {
      font-size: 0.75rem;
      color: #555;
    }

    .history-summary {
      font-size: 0.75rem;
      color: #444;
    }

    .history-item:active {
      opacity: 0.7;
    }

    .badge {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eee;
      white-space: nowrap;
    }

    .delete-button {
      position: absolute;
      right: 8px;
      bottom: 6px;
      font-size: 0.7rem;
      border-radius: 999px;
      border: none;
      padding: 2px 10px;
      background: #ffe5e5;
      color: #a00000;
      cursor: pointer;
    }

    .delete-button:active {
      opacity: 0.8;
    }

    /* Estado de √°nimo */
    .mood-group {
      display: flex;
      gap: 8px;
    }

    .mood-option {
      flex: 1;
      border-radius: 10px;
      border: 1px solid #ddd;
      padding: 6px 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      font-size: 0.8rem;
      cursor: pointer;
      user-select: none;
      background: #fafafa;
    }

    .mood-option input {
      display: none;
    }

    .mood-option.selected {
      border-color: #19692c;
      background: #e5f7ea;
    }

    .mood-emoji {
      font-size: 1.5rem;
      line-height: 1;
    }

    .mood-label {
      font-size: 0.8rem;
    }

    /* Calendario de turnos */
    .schedule-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      margin-top: 4px;
      border: 1px solid #ddd;
    }

    .schedule-table th,
    .schedule-table td {
      padding: 4px 8px;
      border: 1px solid #eee;
      vertical-align: top;
    }

    .schedule-table th {
      background: #f7f7f7;
      font-weight: 600;
      text-align: left;
    }

    .schedule-table td:first-child {
      width: 80px;
      font-weight: 600;
      text-align: left;
      white-space: nowrap;
    }

    .schedule-table td:last-child {
      text-align: left;
    }

    .schedule-table td strong {
      font-weight: 700;
    }

    /* Tabs Turno / Lista */
    .tab-switch {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .tab-btn {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #f5f5f5;
      cursor: pointer;
    }

    .tab-btn.active {
      background: #003f8c;
      color: #fff;
      border-color: #003f8c;
    }

    /* Lista de compras */
    /* Contenedor de grupo para lista de compras */
    .lista-grupo-titulo {
        font-size: 0.85rem;
        font-weight: 600;
        margin-top: 6px;
        margin-bottom: 2px;
        color: #003f8c;
        border-bottom: 1px solid #eee;
        padding-bottom: 2px;
    }
    .lista-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      padding: 4px 0;
      font-size: 0.8rem;
    }
    
    .lista-item-texto {
      flex: 1;
    }

    .lista-item-meta {
        font-size: 0.75rem;
        color: #888;
        white-space: nowrap;
        margin-right: 8px;
    }

    .lista-item-btn {
      font-size: 0.7rem;
      border-radius: 999px;
      border: none;
      padding: 2px 8px;
      cursor: pointer;
      background: #d4f5dd;
      color: #19692c;
    }
    
    button#btnLimpiarComprados {
        font-size: 0.8rem;
        padding: 4px 10px;
        background: #ffe5e5;
        color: #a00000;
        border: none;
    }

    .lista-item-btn:active {
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>üëµüèª TERE - Registro de cuidado</h1>
    <div class="subtitle">
      <em>
        Registro diario por turno<br />
        (comidas, agua, medicaci√≥n y estado de √°nimo)
      </em>
    </div>

    <div class="familia-banner" id="familiaBanner" style="display:none;">
      üë®‚Äçüë©‚Äçüëß Vista familia (solo lectura). Para cargar o editar turnos, us√° el enlace de cuidadoras.
    </div>
    <div class="today-label" id="currentDateLabel"></div>

    <div class="card">
      <h2>
        <span>üìÖ Datos del turno</span>
        <div class="tab-switch">
          <button type="button" class="tab-btn active" id="tabTurno">Turno</button>
          <button type="button" class="tab-btn" id="tabLista">Lista üõí</button>
        </div>
      </h2>

      <div id="panelTurno">
        <div class="two-cols">
          <div class="row">
            <label for="fecha">Fecha</label>
            <input type="date" id="fecha" />
          </div>
          <div class="row">
            <label for="turno">Turno</label>
            <select id="turno">
              <option value="maniana">Ma√±ana</option>
              <option value="tarde">Tarde</option>
              <option value="noche">Noche</option>
              <option value="completo">24 hs</option>
            </select>
          </div>
        </div>
        <div class="row">
          <label for="cuidador">Cuidadora</label>
          <select id="cuidador">
            <option value="guadalupe">Guadalupe</option>
            <option value="aylen">Ayl√©n</option>
            <option value="noelia">Noelia</option>
            <option value="rocio">Roc√≠o</option>
            <option value="otro">Familiar / Otro</option>
          </select>
        </div>
        <div class="small-text" id="suggestInfo"></div>
        <div class="saved-message" id="savedMessage"></div>
        <div class="small-text" id="turnoInfo"></div>

        <button type="button" class="small-chip secondary" id="btnTurnoAhora" style="margin-top:6px;">
          Turno en curso
        </button>
      </div>

      <div id="panelLista" style="display:none; margin-top:4px;">
        <div class="small-text" style="margin-bottom:6px;">
          Us√° esta pesta√±a para ir anotando lo que falte comprar. Se guarda en la base y se ve igual desde cualquier dispositivo.
        </div>
        
        <div id="listaEstado" class="small-text" style="text-align:center; margin-bottom:4px;"></div>

        <div class="row">
          <label for="listaCategoria">Categor√≠a</label>
          <select id="listaCategoria">
            <option value="almacen">Almac√©n</option>
            <option value="verduleria">Verduler√≠a</option>
            <option value="carniceria">Carnicer√≠a</option>
            <option value="otro">Otro</option>
          </select>
        </div>

        <div class="row">
          <label for="listaItem">Producto</label>
          <input type="text" id="listaItem" placeholder="Ej: yogur bebible" />
        </div>

        <div class="row">
          <label for="listaCantidad">Cantidad</label>
          <input type="text" id="listaCantidad" placeholder="Ej: 1 unidad, 1 paquete" />
        </div>

        <button type="button" class="export-btn" id="listaAgregar">‚ûï Agregar a la lista</button>

        <div class="small-text" style="margin-top:12px; font-weight: 600;">Pendientes:</div>
        <div id="listaPendientes" style="margin-top:4px;"></div>

        <div style="display:flex; align-items:center; justify-content:space-between; margin-top:10px;">
          <div class="small-text" style="font-weight: 600;">Comprados recientemente:</div>
          <button type="button" class="lista-item-btn" id="btnLimpiarComprados">
            üßπ Limpiar
          </button>
        </div>
        <div id="listaComprados" style="margin-top:4px;"></div>
      </div>
    </div>

    <div class="card">
      <h2>
        <span>üç≥ Comidas del d√≠a</span>
        <span id="statusComidas" class="status-pill"></span>
      </h2>
      <div class="checkbox-grid">
        <label class="checkbox-item">
          <input type="checkbox" id="desayuno" />
          <span>Desayuno</span>
        </label>
        <label class="checkbox-item">
          <input type="checkbox" id="almuerzo" />
          <span>Almuerzo</span>
        </label>
        <label class="checkbox-item">
          <input type="checkbox" id="merienda" />
          <span>Merienda</span>
        </label>
        <label class="checkbox-item">
          <input type="checkbox" id="cena" />
          <span>Cena</span>
        </label>
      </div>
      <div class="small-text">Tildar en el turno en el que se realiza cada comida.</div>
    </div>

    <div class="card">
      <h2>üíß Agua (por turno)</h2>
      <div class="row">
        <label for="aguaVasos">Vasos tomados en el d√≠a</label>
        <input type="number" id="aguaVasos" min="0" max="40" step="1" inputmode="numeric" />
      </div>
      <div class="small-text">Actualizar a lo largo del d√≠a. Se consolida entre turnos.</div>
    </div>

    <div class="card">
      <h2>
        <span>üíä Medicaci√≥n del d√≠a</span>
        <span id="statusMed" class="status-pill"></span>
      </h2>
      <div class="checkbox-grid">
        <label class="checkbox-item">
          <input type="checkbox" id="medManiana" />
          <span>Ma√±ana</span>
        </label>
        <label class="checkbox-item">
          <input type="checkbox" id="medNoche" />
          <span>Noche</span>
        </label>
      </div>
      <div class="small-text">
        La pastilla de la ma√±ana y de la noche deben estar marcadas para considerar el d√≠a completo.
      </div>
    </div>

    <div class="card">
      <h2>Estado de √°nimo (turno)</h2>
      <div class="mood-group">
        <label class="mood-option">
          <input type="radio" name="estadoAnimo" value="bien" />
          <span class="mood-emoji">üôÇ</span>
          <span class="mood-label">Bien</span>
        </label>
        <label class="mood-option">
          <input type="radio" name="estadoAnimo" value="neutral" />
          <span class="mood-emoji">üòê</span>
          <span class="mood-label">Normal</span>
        </label>
        <label class="mood-option">
          <input type="radio" name="estadoAnimo" value="mal" />
          <span class="mood-emoji">üòü</span>
          <span class="mood-label">Mal</span>
        </label>
      </div>
      <div class="small-text">Elegir el estado de √°nimo predominante en este turno.</div>
    </div>

    <div class="card">
      <h2>üìù Notas del turno</h2>
      <div class="row">
        <label for="notas">Observaciones</label>
        <textarea id="notas" placeholder="Ej: comi√≥ poco, se quej√≥ de dolor, durmi√≥ bien/mal, etc."></textarea>
      </div>
      <button class="reset-btn" id="resetDia">Borrar registro de este turno</button>
    </div>

    <div class="card">
      <h2>üìä Dashboard del d√≠a</h2>
      <div id="resumenTexto" class="dashboard-grid"></div> 
    </div>

    <div class="card">
      <h2>Historial reciente</h2>
      <div class="small-text">
        Ver √∫ltimos turnos registrados. Toc√° un √≠tem para cargarlo en el formulario.<br />
        El resumen se consolida por d√≠a (comidas, medicaci√≥n y agua).<br/>
        <span style="font-weight: 600;">*El horario indica cu√°ndo se cre√≥ el registro.</span>
      </div>
      <div id="historialLista" class="history-list"></div>
    </div>

    <div class="card">
      <h2>üóìÔ∏è Calendario de turnos</h2>
      <div class="small-text">Referencia seg√∫n el cronograma acordado.</div>
      <table class="schedule-table">
        <thead>
          <tr>
            <th>D√≠a</th>
            <th>Horarios y cuidadores</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Lunes</td>
            <td>
              12:00 a 18:00 ‚Äî <strong>GUADA</strong><br />
              20:00 a 08:00 ‚Äî <strong>NOELIA</strong> <small>(hasta el martes)</small>
            </td>
          </tr>
          <tr>
            <td>Martes</td>
            <td>
              12:00 a 16:00 ‚Äî <strong>AYL√âN</strong><br />
              21:00 a 12:00 ‚Äî <strong>GUADA</strong> <small>(hasta el mi√©rcoles)</small>
            </td>
          </tr>
          <tr>
            <td>Mi√©rcoles</td>
            <td>
              12:00 a 18:00 ‚Äî <strong>GUADA</strong><br />
              20:00 a 08:00 ‚Äî <strong>NOELIA</strong> <small>(hasta el jueves)</small>
            </td>
          </tr>
          <tr>
            <td>Jueves</td>
            <td>
              12:00 a 16:00 ‚Äî <strong>AYL√âN</strong><br />
              20:00 a 08:00 ‚Äî <strong>NOELIA</strong> <small>(hasta el viernes)</small>
            </td>
          </tr>
          <tr>
            <td>Viernes</td>
            <td>
              09:00 a 18:00 ‚Äî <strong>GUADA</strong><br />
              20:00 a 08:00 ‚Äî <strong>NOELIA</strong> <small>(hasta el s√°bado)</small>
            </td>
          </tr>
          <tr>
            <td>S√°bado</td>
            <td>
              20:00 a 08:00 ‚Äî <strong>ROC√çO</strong> <small>(hasta el domingo)</small>
            </td>
          </tr>
          <tr>
            <td>Domingo</td>
            <td>
              19:00 a 08:00 ‚Äî <strong>ROC√çO</strong> <small>(hasta el lunes)</small>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="card" id="exportCard">
      <h2>Exportar registros</h2>
      <button class="export-btn" id="exportDia">‚¨áÔ∏è Exportar d√≠a a Excel / Sheets</button>
      <div class="small-text">Genera un CSV con todos los turnos del d√≠a seleccionado.</div>
    </div>

    <div class="footer-info">
      Developed by Cundo.NET
    </div>
  </div>

  <script>
    const API_BASE = "/api";
    const DELETE_PIN = "1905";

    // Modo familia / solo lectura
    const params = new URLSearchParams(window.location.search);
    const viewParam = params.get("view");
    const isFamiliaView = viewParam === "familia" || viewParam === "readonly";

    // --- NUEVA FUNCI√ìN DEBOUCE PARA OPTIMIZACI√ìN DE GUARDADO ---
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }
    // -------------------------------------------------------------

    // --- API helpers turno (Mantenidas) ---
    async function apiGuardar(record) {
      const res = await fetch(API_BASE + "/guardar-registro", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(record),
      });
      if (!res.ok) throw new Error("Error al guardar registro");
      try { return await res.json(); } catch { return {}; }
    }

    async function apiListar(params = {}) {
      const url = new URL(API_BASE + "/listar-registros", window.location.origin);
      Object.entries(params).forEach(([k, v]) => {
        if (v !== undefined && v !== null && v !== "") {
          url.searchParams.set(k, v);
        }
      });
      const res = await fetch(url.toString());
      if (!res.ok) throw new Error("Error al leer registros");
      return await res.json();
    }

    async function apiBorrar(id) {
      const url = new URL(API_BASE + "/borrar-registro", window.location.origin);
      url.searchParams.set("id", id);
      const res = await fetch(url.toString(), { method: "POST" });
      if (!res.ok) throw new Error("Error al borrar registro");
      return await res.json();
    }

    // --- API Lista de compras (ACTUALIZADAS CON TUS FUNCIONES) ---
    async function apiListaListar() {
      const res = await fetch(API_BASE + "/lista-compras-listar");
      if (!res.ok) throw new Error("Error al leer lista de compras");
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Error en lista-compras-listar");
      return data.items || [];
    }
    
    async function apiListaAgregar(item) {
      const res = await fetch(API_BASE + "/lista-compras-agregar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(item),
      });
      if (!res.ok) throw new Error("Error al agregar a la lista");
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Error en lista-compras-agregar");
      return data.item;
    }
    
    async function apiListaMarcar(id, estado, compradoPor) {
      const res = await fetch(API_BASE + "/lista-compras-marcar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, estado, compradoPor }),
      });
      if (!res.ok) throw new Error("Error al actualizar √≠tem");
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Error en lista-compras-marcar");
      return data.item;
    }
    
    async function apiListaLimpiarComprados() {
      const res = await fetch(API_BASE + "/lista-compras-limpiar", {
        method: "POST",
      });
      if (!res.ok) throw new Error("Error al limpiar lista");
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Error en lista-compras-limpiar");
      return data.deleted || 0;
    }
    // ------------------------------------------------------------------------

    // --- DOM refs (Actualizados para la nueva l√≥gica de lista) ---
    const currentDateLabel = document.getElementById("currentDateLabel");
    const familiaBanner = document.getElementById("familiaBanner");
    const fechaInput       = document.getElementById("fecha");
    const turnoSelect      = document.getElementById("turno");
    const cuidadorSelect   = document.getElementById("cuidador");
    const desayunoInput    = document.getElementById("desayuno");
    const almuerzoInput    = document.getElementById("almuerzo");
    const meriendaInput    = document.getElementById("merienda");
    const cenaInput        = document.getElementById("cena");
    const aguaInput        = document.getElementById("aguaVasos");
    const medManianaInput  = document.getElementById("medManiana");
    const medNocheInput    = document.getElementById("medNoche");
    const notasInput       = document.getElementById("notas");
    const statusComidas    = document.getElementById("statusComidas");
    const statusMed        = document.getElementById("statusMed");
    const resumenTexto     = document.getElementById("resumenTexto");
    const savedMessage     = document.getElementById("savedMessage");
    const resetDiaBtn      = document.getElementById("resetDia");
    const historialLista   = document.getElementById("historialLista");
    const suggestInfo      = document.getElementById("suggestInfo");
    const turnoInfo        = document.getElementById("turnoInfo");
    const exportDiaBtn     = document.getElementById("exportDia");
    const exportCard       = document.getElementById("exportCard");
    const btnTurnoAhora    = document.getElementById("btnTurnoAhora");

    const moodOptions      = document.querySelectorAll(".mood-option");
    const moodRadios       = document.querySelectorAll('input[name="estadoAnimo"]');

    const tabTurno   = document.getElementById("tabTurno");
    const tabLista   = document.getElementById("tabLista");
    const panelTurno = document.getElementById("panelTurno");
    const panelLista = document.getElementById("panelLista");

    const listaCategoria      = document.getElementById("listaCategoria");
    const listaItem           = document.getElementById("listaItem"); // ID de producto en el HTML
    const listaProducto       = listaItem; // Alias para usar en la nueva l√≥gica de agregar
    const listaCantidad       = document.getElementById("listaCantidad");
    const listaAgregarBtn     = document.getElementById("listaAgregar"); // ID del bot√≥n en el HTML

    const listaPendientes     = document.getElementById("listaPendientes");
    const listaComprados      = document.getElementById("listaComprados");
    const btnLimpiarComprados = document.getElementById("btnLimpiarComprados");
    const listaEstado         = document.getElementById("listaEstado"); // Nuevo ref para status

    if (!isFamiliaView && exportCard) {
      exportCard.style.display = "none";
    }

    let saveTimeout = null;
    let lastCuidadorValue = cuidadorSelect.value;
    let listaComprasData = []; // Mantener esto para el estado local
    
    // --- Calendario de turnos (Mantenido) ---
    const schedule = {
      1: [
        { from: 0, to: 8 * 60,  cuidador: "rocio", horario: "20:00 - 08:00" },
        { from: 12 * 60, to: 18 * 60, cuidador: "guadalupe", horario: "12:00 - 18:00" },
        { from: 20 * 60, to: 24 * 60, cuidador: "noelia", horario: "20:00 - 08:00" }
      ],
      // ... (resto de tu schedule)
      2: [
        { from: 0, to: 8 * 60,  cuidador: "noelia", horario: "20:00 - 08:00" },
        { from: 12 * 60, to: 16 * 60, cuidador: "aylen", horario: "12:00 - 16:00" },
        { from: 21 * 60, to: 24 * 60, cuidador: "guadalupe", horario: "21:00 - 12:00" }
      ],
      3: [
        { from: 0, to: 12 * 60, cuidador: "guadalupe", horario: "21:00 - 12:00" },
        { from: 12 * 60, to: 18 * 60, cuidador: "guadalupe", horario: "12:00 - 18:00" },
        { from: 20 * 60, to: 24 * 60, cuidador: "noelia", horario: "20:00 - 08:00" }
      ],
      4: [
        { from: 0, to: 8 * 60,  cuidador: "noelia", horario: "20:00 - 08:00" },
        { from: 12 * 60, to: 16 * 60, cuidador: "aylen", horario: "12:00 - 16:00" },
        { from: 20 * 60, to: 24 * 60, cuidador: "noelia", horario: "20:00 - 08:00" }
      ],
      5: [
        { from: 0, to: 8 * 60,  cuidador: "noelia", horario: "20:00 - 08:00" },
        { from: 9 * 60, to: 18 * 60, cuidador: "guadalupe", horario: "09:00 - 18:00" },
        { from: 20 * 60, to: 24 * 60, cuidador: "noelia", horario: "20:00 - 08:00" }
      ],
      6: [
        { from: 0, to: 8 * 60,  cuidador: "noelia", horario: "20:00 - 08:00" },
        { from: 20 * 60, to: 24 * 60, cuidador: "rocio", horario: "20:00 - 08:00" }
      ],
      0: [
        { from: 0, to: 8 * 60,  cuidador: "rocio", horario: "19:00 - 08:00" },
        { from: 19 * 60, to: 24 * 60, cuidador: "rocio", horario: "19:00 - 08:00" }
      ]
    };
    
    function hoyISO() {
      const hoy = new Date();
      const y = hoy.getFullYear();
      const m = String(hoy.getMonth() + 1).padStart(2, "0");
      const d = String(hoy.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function formatHoyHumano() {
      const hoy = new Date();
      const opts = { weekday: "long", year: "numeric", month: "2-digit", day: "2-digit" };
      return hoy.toLocaleDateString("es-AR", opts);
    }

    function getNowInfo() {
      const now = new Date();
      const dow = now.getDay();
      const minutes = now.getHours() * 60 + now.getMinutes();
      return { dow, minutes, now };
    }

    function getCaregiverFor(dow, minutes) {
      const daySched = schedule[dow] || [];
      for (const slot of daySched) {
        if (minutes >= slot.from && minutes < slot.to) return slot.cuidador;
      }
      return null;
    }

    function getScheduledCuidadorForFechaTurno(fechaStr, turno) {
      const base = fechaStr || hoyISO();
      const fecha = new Date(base + "T12:00:00");
      const dow = fecha.getDay();

      let minutes;
      switch (turno) {
        case "maniana": minutes = 9 * 60; break;
        case "tarde":   minutes = 15 * 60; break;
        case "noche":   minutes = 22 * 60; break;
        case "completo":default: minutes = 12 * 60;
      }
      return getCaregiverFor(dow, minutes);
    }

    function guessTurnoFromMinutes(minutes) {
      if (minutes >= 6 * 60 && minutes < 12 * 60) return "maniana";
      if (minutes >= 12 * 60 && minutes < 20 * 60) return "tarde";
      return "noche";
    }

    function getTurnoHorario(fechaStr, turno) {
        const base = fechaStr || hoyISO();
        const fecha = new Date(base + "T12:00:00");
        const dow = fecha.getDay();
        const daySched = schedule[dow] || [];
        
        let targetMinutes;
        switch (turno) {
            case "maniana": targetMinutes = 9 * 60; break;
            case "tarde": targetMinutes = 15 * 60; break;
            case "noche": targetMinutes = 22 * 60; break;
            default: targetMinutes = 12 * 60;
        }
        
        for (const slot of daySched) {
            if (targetMinutes >= slot.from && targetMinutes < slot.to) {
                return slot.horario;
            }
        }
        return null;
    }

    function getSelectedMood() {
      let value = "";
      moodRadios.forEach(r => { if (r.checked) value = r.value; });
      return value;
    }

    function setMoodUI(value) {
      moodOptions.forEach(opt => {
        const radio = opt.querySelector('input[name="estadoAnimo"]');
        const match = radio.value === value;
        radio.checked = match;
        opt.classList.toggle("selected", match);
      });
    }

    function clearMoodUI() {
      setMoodUI("");
    }

    function moodEmoji(value) {
      if (value === "bien") return "üôÇ";
      if (value === "neutral") return "üòê";
      if (value === "mal") return "üòü";
      return "";
    }

    function labelCuidador(value) {
      switch (value) {
        case "guadalupe": return "Guadalupe";
        case "aylen":     return "Ayl√©n";
        case "noelia":    return "Noelia";
        case "rocio":     return "Roc√≠o";
        case "otro":      return "Familiar / Otro";
        default:          return value;
      }
    }

    function labelTurno(value) {
      switch (value) {
        case "maniana": return "Ma√±ana";
        case "tarde":   return "Tarde";
        case "noche":   return "Noche";
        case "completo":return "24 hs";
        default:        return value || "-";
      }
    }

    function labelCategoria(cat) {
      switch (cat) {
        case "almacen":    return "Almac√©n";
        case "verduleria": return "Verduler√≠a";
        case "carniceria": return "Carnicer√≠a";
        default:           return "Otro";
      }
    }

    function formatFecha(fechaStr) {
      if (!fechaStr) return "-";
      const base = fechaStr.slice(0, 10);
      const [y, m, d] = base.split("-");
      if (!y || !m || !d) return fechaStr;
      return `${d}/${m}/${y}`;
    }

    function getHoraDesdeRec(rec) {
      const raw = rec.created_at || rec.hora || rec.fecha_hora;
      if (!raw) return "";
      const date = new Date(raw);
      if (isNaN(date.getTime())) return "";
      const hh = String(date.getHours()).padStart(2, "0");
      const mm = String(date.getMinutes()).padStart(2, "0");
      return `${hh}:${mm}`;
    }

    function mostrarGuardado() {
      savedMessage.textContent = "Guardado en TERE ‚úÖ";
      if (saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => { savedMessage.textContent = ""; }, 1500);
    }

    async function fetchRecordForCurrentKey() {
      const fecha = fechaInput.value || hoyISO();
      const cuidador = cuidadorSelect.value;
      const turno = turnoSelect.value;

      const rows = await apiListar({ fecha, cuidador, turno });
      if (!rows || rows.length === 0) return null;

      const r = rows[0];
      return {
        fecha,
        turno,
        cuidador,
        desayuno:   !!r.desayuno,
        almuerzo:   !!r.almuerzo,
        merienda:   !!r.merienda,
        cena:       !!r.cena,
        aguaVasos:  r.agua_vasos ?? 0,
        medManiana: !!r.med_maniana,
        medNoche:   !!r.med_noche,
        notas:      r.notas || "",
        estadoAnimo:r.estado_animo || ""
      };
    }

    async function getDailySummary(fechaStr) {
      const registros = await apiListar({ fecha: fechaStr });
      const result = {
        desayuno: false,
        almuerzo: false,
        merienda: false,
        cena: false,
        medManiana: false,
        medNoche: false,
        aguaVasos: 0,
        turnos: 0,
        animoCounts: { bien: 0, neutral: 0, mal: 0 }
      };
      registros.forEach(rec => {
        result.turnos += 1;
        if (rec.desayuno)    result.desayuno = true;
        if (rec.almuerzo)    result.almuerzo = true;
        if (rec.merienda)    result.merienda = true;
        if (rec.cena)        result.cena = true;
        if (rec.med_maniana) result.medManiana = true;
        if (rec.med_noche)   result.medNoche = true;
        const agua = rec.agua_vasos || 0;
        if (agua > result.aguaVasos) result.aguaVasos = agua;
        
        if (rec.estado_animo && rec.estado_animo in result.animoCounts) {
            result.animoCounts[rec.estado_animo]++;
        }
      });
      return result;
    }

    async function actualizarEstadosVisuales() {
      const anyMeal = desayunoInput.checked || almuerzoInput.checked ||
                      meriendaInput.checked || cenaInput.checked;
      const allMeals = desayunoInput.checked && almuerzoInput.checked &&
                       meriendaInput.checked && cenaInput.checked;
      statusComidas.classList.remove("status-ok", "status-pending", "status-danger");
      if (allMeals) {
        statusComidas.textContent = "Completas (turno)";
        statusComidas.classList.add("status-ok");
      } else if (anyMeal) {
        statusComidas.textContent = "Incompletas (turno)";
        statusComidas.classList.add("status-pending");
      } else {
        statusComidas.textContent = "Sin registrar (turno)";
        statusComidas.classList.add("status-danger");
      }

      const medAny = medManianaInput.checked || medNocheInput.checked;
      const medAll = medManianaInput.checked && medNocheInput.checked;
      statusMed.classList.remove("status-ok", "status-pending", "status-danger");
      if (medAll) {
        statusMed.textContent = "Completa (turno)";
        statusMed.classList.add("status-ok");
      } else if (medAny) {
        statusMed.textContent = "Incompleta (turno)";
        statusMed.classList.add("status-pending");
      } else {
        statusMed.textContent = "Sin registrar (turno)";
        statusMed.classList.add("status-danger");
      }

      // 2. Resumen del D√≠a (Dashboard MEJORADO)
      const fechaDia = fechaInput.value || hoyISO();
      try {
        const daily = await getDailySummary(fechaDia);
        const partesHTML = []; 

        // 2.1. Estado de Comidas del D√≠a
        const todasComidasDia = daily.desayuno && daily.almuerzo && daily.merienda && daily.cena;
        const comidaStatus = todasComidasDia ? 'status-ok' : 'status-pending';
        let comidaTexto;
        if (todasComidasDia) {
            comidaTexto = '‚úÖ Comidas Completas';
        } else {
            const faltantes = [];
            if (!daily.desayuno) faltantes.push("D");
            if (!daily.almuerzo) faltantes.push("A");
            if (!daily.merienda) faltantes.push("M");
            if (!daily.cena) faltantes.push("C");
            comidaTexto = `‚ö†Ô∏è Faltan: ${faltantes.join(", ")}`;
        }
        partesHTML.push(`<div class="status-pill ${comidaStatus}">${comidaTexto}</div>`);

        // 2.2. Estado de Medicaci√≥n del D√≠a
        const medCompleta = daily.medManiana && daily.medNoche;
        const medStatus = medCompleta ? 'status-ok' : (daily.medManiana || daily.medNoche ? 'status-pending' : 'status-danger');
        let medTexto;
        if (medCompleta) {
            medTexto = '‚úÖ Med. Completa';
        } else if (daily.medManiana || daily.medNoche) {
            medTexto = '‚ö†Ô∏è Med. Incompleta';
        } else {
            medTexto = '‚ùå Sin Medicaci√≥n';
        }
        partesHTML.push(`<div class="status-pill ${medStatus}">${medTexto}</div>`);

        // 2.3. Consumo de Agua
        const vasos = daily.aguaVasos || 0;
        const aguaStatus = vasos >= 6 ? 'status-ok' : (vasos > 0 ? 'status-pending' : 'status-danger');
        partesHTML.push(`<div class="status-pill ${aguaStatus}">üíß Agua: ${vasos} vaso(s)</div>`);
        
        // 2.4. Turnos Registrados
        const turnoStatus = daily.turnos > 0 ? 'status-pill' : 'status-danger';
        partesHTML.push(`<div class="status-pill ${turnoStatus}">üìã ${daily.turnos} Turno(s)</div>`);
        
        // 2.5. Estado de √Ånimo (predominante)
        const moods = Object.entries(daily.animoCounts);
        moods.sort((a, b) => b[1] - a[1]); 
        
        if (moods.length > 0 && moods[0][1] > 0) {
            const predominante = moods[0][0];
            const emoji = moodEmoji(predominante);
            const label = predominante === 'neutral' ? 'Normal' : (predominante === 'bien' ? 'Bien' : 'Mal');
            partesHTML.push(`<div class="status-pill">${emoji} √Ånimo: ${label}</div>`);
        } else {
            partesHTML.push(`<div class="status-pill status-pending">üò∂ √Ånimo no registrado</div>`);
        }

        resumenTexto.innerHTML = partesHTML.join(''); 
        
      } catch (e) {
        console.error(e);
        resumenTexto.textContent = "No se pudo obtener el resumen diario (problema de conexi√≥n).";
      }
    }

    async function saveCurrentRecord() {
      const record = {
        fecha: fechaInput.value || hoyISO(),
        turno: turnoSelect.value,
        cuidador: cuidadorSelect.value,
        desayuno: desayunoInput.checked,
        almuerzo: almuerzoInput.checked,
        merienda: meriendaInput.checked,
        cena: cenaInput.checked,
        aguaVasos: parseInt(aguaInput.value || "0", 10),
        medManiana: medManianaInput.checked,
        medNoche: medNocheInput.checked,
        notas: notasInput.value || "",
        estadoAnimo: getSelectedMood()
      };
      try {
        await apiGuardar(record);
        mostrarGuardado();
        await actualizarEstadosVisuales();
        await buildHistory();
      } catch (e) {
        console.error(e);
        alert("No se pudo guardar en la base central. Revisar conexi√≥n.");
      }
    }

    async function loadCurrentRecord() {
      try {
        const rec = await fetchRecordForCurrentKey();
        if (rec) {
          desayunoInput.checked   = rec.desayuno;
          almuerzoInput.checked   = rec.almuerzo;
          meriendaInput.checked   = rec.merienda;
          cenaInput.checked       = rec.cena;
          aguaInput.value         = rec.aguaVasos || "";
          medManianaInput.checked = rec.medManiana;
          medNocheInput.checked   = rec.medNoche;
          notasInput.value        = rec.notas || "";
          setMoodUI(rec.estadoAnimo);
        } else {
          desayunoInput.checked   = false;
          almuerzoInput.checked   = false;
          meriendaInput.checked   = false;
          cenaInput.checked       = false;
          aguaInput.value         = "";
          medManianaInput.checked = false;
          medNocheInput.checked   = false;
          notasInput.value        = "";
          clearMoodUI();
        }
        await actualizarEstadosVisuales();
        savedMessage.textContent = "";
      } catch (e) {
        console.error(e);
      }
    }

    async function resetCurrentRecord() {
      desayunoInput.checked   = false;
      almuerzoInput.checked   = false;
      meriendaInput.checked   = false;
      cenaInput.checked       = false;
      aguaInput.value         = "";
      medManianaInput.checked = false;
      medNocheInput.checked   = false;
      notasInput.value        = "";
      clearMoodUI();
      await saveCurrentRecord();
    }

    // --- Cargar + renderizar la lista (NUEVA L√ìGICA) ---
    async function cargarListaCompras() {
      if (!listaPendientes || !listaComprados) return;

      try {
        listaEstado.textContent = "Cargando lista...";
        listaComprasData = await apiListaListar();
        renderListaCompras();
        listaEstado.textContent = "";
      } catch (err) {
        console.error(err);
        listaEstado.textContent = "No se pudo cargar la lista (problema de conexi√≥n).";
      }
    }

    function renderListaCompras() {
      listaPendientes.innerHTML = "";
      listaComprados.innerHTML = "";

      const pendientes = listaComprasData.filter(i => i.estado === "pendiente");
      const comprados  = listaComprasData.filter(i => i.estado === "comprado");

      // Helper para agrupar por categor√≠a
      function buildGroup(container, items, opts = {}) {
        const { showCompradoButton = true } = opts;

        const byCat = new Map();
        items.forEach(it => {
          const catName = labelCategoria(it.categoria || 'otro');
          if (!byCat.has(catName)) byCat.set(catName, []);
          byCat.get(catName).push(it);
        });

        if (byCat.size === 0) {
          const empty = document.createElement("div");
          empty.className = "small-text";
          empty.textContent = "Sin √≠tems.";
          container.appendChild(empty);
          return;
        }

        for (const [catName, list] of byCat.entries()) {
          const box = document.createElement("div");
          box.className = "lista-grupo";

          const title = document.createElement("div");
          title.className = "lista-grupo-titulo";
          title.textContent = catName;
          box.appendChild(title);

          list.forEach(it => {
            const row = document.createElement("div");
            row.className = "lista-item";
            row.style.opacity = it.estado === 'comprado' ? 0.7 : 1;

            const txt = document.createElement("div");
            txt.className = "lista-item-texto";
            txt.textContent = `${it.producto} ‚Äî ${it.cantidad}`;
            row.appendChild(txt);

            if (it.comprado_en || it.comprado_por) {
              const meta = document.createElement("div");
              meta.className = "lista-item-meta";
              meta.textContent = `Comprado${it.comprado_por ? ` por ${labelCuidador(it.comprado_por)}` : ""}`;
              row.appendChild(meta);
            }

            if (showCompradoButton && !isFamiliaView) {
              const btn = document.createElement("button");
              btn.className = "lista-item-btn";
              btn.textContent = it.estado === "pendiente" ? "‚úÖ Comprado" : "‚Ü©Ô∏è Desmarcar";
              btn.style.backgroundColor = it.estado === "pendiente" ? '' : '#f0f0f0';
              btn.style.color = it.estado === "pendiente" ? '' : '#444';

              btn.addEventListener("click", async () => {
                try {
                  const nuevoEstado = it.estado === "pendiente" ? "comprado" : "pendiente";
                  const comprador = cuidadorSelect ? cuidadorSelect.value : 'otro';
                  const actualizado = await apiListaMarcar(
                    it.id,
                    nuevoEstado,
                    nuevoEstado === 'comprado' ? comprador : null
                  );
                  
                  // Actualizar en memoria
                  const idx = listaComprasData.findIndex(x => x.id === it.id);
                  if (idx >= 0) listaComprasData[idx] = actualizado;
                  renderListaCompras();
                } catch (err) {
                  console.error(err);
                  alert("No se pudo actualizar el √≠tem.");
                }
              });
              row.appendChild(btn);
            }

            box.appendChild(row);
          });

          container.appendChild(box);
        }
      }

      // üõí Pendientes -> bot√≥n disponible (solo para cuidadoras, controlado por isFamiliaView)
      buildGroup(listaPendientes, pendientes, { showCompradoButton: true });

      // ‚è≥ Comprados -> solo lectura
      buildGroup(listaComprados, comprados.slice(0, 10), { showCompradoButton: false });
      
      // Controla la visibilidad del bot√≥n de limpieza
      if (btnLimpiarComprados) {
        btnLimpiarComprados.style.display = comprados.length > 0 && !isFamiliaView ? 'inline-block' : 'none';
      }
    }
    // ------------------------------------------------------------------------

    async function saveCurrentRecordDebounced() {
        if (isFamiliaView) return;
        await saveCurrentRecord();
    }
    
    const debouncedSaveRecord = debounce(saveCurrentRecordDebounced, 500);

    function sugerirTurnoYCuidadorSegunAhora() {
      const hoy = hoyISO();
      fechaInput.value = hoy;

      const { dow, minutes, now } = getNowInfo();
      const turnoGuess = guessTurnoFromMinutes(minutes);
      turnoSelect.value = turnoGuess;
      const scheduled = getCaregiverFor(dow, minutes);

      if (scheduled) {
        cuidadorSelect.value = scheduled;
        suggestInfo.textContent = "Cuidadora sugerida autom√°ticamente seg√∫n calendario del turno.";
      } else {
        suggestInfo.textContent = "Fuera de un turno fijo: seleccionar cuidadora manualmente.";
      }

      lastCuidadorValue = cuidadorSelect.value;

      const hora = String(now.getHours()).padStart(2, "0");
      const min  = String(now.getMinutes()).padStart(2, "0");
      turnoInfo.textContent = `Turno en curso estimado: ${labelTurno(turnoGuess)} ¬∑ ${hora}:${min} hs`;
    }

    async function handleCuidadorChange() {
      const newValue = cuidadorSelect.value;
      const fechaSel = fechaInput.value || hoyISO();
      const turnoSel = turnoSelect.value;

      const scheduled = getScheduledCuidadorForFechaTurno(fechaSel, turnoSel);
      if (scheduled && newValue !== "otro" && newValue !== scheduled) {
        const nombreProgramado = labelCuidador(scheduled);
        const nombreNuevo      = labelCuidador(newValue);
        const ok = window.confirm(
          `${nombreNuevo} no est√° programada para este turno.\n` +
          `Seg√∫n el calendario deber√≠a estar ${nombreProgramado}.\n\n` +
          `¬øConfirm√°s que ${nombreNuevo} est√° cubriendo el turno?`
        );
        if (!ok) {
          cuidadorSelect.value = lastCuidadorValue;
          return;
        }
      }

      lastCuidadorValue = newValue;
      suggestInfo.textContent = "";
      await loadCurrentRecord();
    }

    function activarTabTurno() {
      tabTurno.classList.add("active");
      tabLista.classList.remove("active");
      panelTurno.style.display = "";
      panelLista.style.display = "none";
    }

    function activarTabLista() {
      tabLista.classList.add("active");
      tabTurno.classList.remove("active");
      panelTurno.style.display = "none";
      panelLista.style.display = "";
    }

    function setupLimpiarComprados() {
      if (!btnLimpiarComprados || isFamiliaView) return;
      
      btnLimpiarComprados.addEventListener("click", async () => {
          const pin = window.prompt("Ingres√° el PIN para limpiar la lista de comprados:");
          if (pin !== DELETE_PIN) return;
          
          if (!window.confirm("CONFIRMACI√ìN FINAL: Esto borrar√° PERMANENTEMENTE los √≠tems comprados de la base de datos.")) {
              return;
          }

          try {
            const deletedCount = await apiListaLimpiarComprados(); 
            await cargarListaCompras();
            alert(`Lista de comprados limpiada con √©xito. (${deletedCount} √≠tems borrados).`);
          } catch (e) {
            console.error(e);
            alert("ERROR: No se pudo limpiar la lista. Revisar conexi√≥n o implementaci√≥n de la ruta /api/lista-compras-limpiar.");
          }
      });
    }

    function aplicarModoFamilia() {
      if (!isFamiliaView) return;

      if (familiaBanner) familiaBanner.style.display = "block";
      turnoSelect.disabled    = true;
      cuidadorSelect.disabled = true;

      [
        desayunoInput, almuerzoInput, meriendaInput, cenaInput,
        aguaInput, medManianaInput, medNocheInput
      ].forEach(el => {
        if (!el) return;
        el.disabled = true;
        el.style.opacity = 0.7;
      });

      if (notasInput) {
        notasInput.readOnly = true;
        notasInput.style.backgroundColor = "#f9f9f9";
      }

      moodOptions.forEach(opt => {
        opt.style.pointerEvents = "none";
        opt.style.opacity = 0.6;
      });
      if (resetDiaBtn)   resetDiaBtn.style.display = "none";
      if (btnTurnoAhora) btnTurnoAhora.style.display = "none";
      if (listaAgregarBtn) listaAgregarBtn.style.display = "none";
      if (exportCard)   exportCard.style.display = "block";
      if (exportDiaBtn) exportDiaBtn.style.display = "block";
    }

    async function init() {
      const hoy = hoyISO();
      currentDateLabel.textContent = "Hoy: " + formatHoyHumano();
    
      if (fechaInput) {
        fechaInput.max = hoy;
      }
    
      sugerirTurnoYCuidadorSegunAhora();
      await loadCurrentRecord();

      await buildHistory();
      await cargarListaCompras(); // Llama a la nueva funci√≥n de carga

      fechaInput.addEventListener("change", () => {
          const hoy = hoyISO();
          if (fechaInput.value && fechaInput.value > hoy) {
              alert("No se pueden cargar datos en fechas futuras. Se volvi√≥ a la fecha de hoy.");
              fechaInput.value = hoy;
          }
          suggestInfo.textContent = "";
          loadCurrentRecord();
      });
      turnoSelect.addEventListener("change", () => {
          loadCurrentRecord();
      });
      cuidadorSelect.addEventListener("change", () => {
          handleCuidadorChange();
      });
      
      [
          desayunoInput, almuerzoInput, meriendaInput, cenaInput,
          medManianaInput, medNocheInput
      ].forEach(el =>
          el.addEventListener("change", () => {
              if (isFamiliaView) return;
              saveCurrentRecord();
          })
      );

      aguaInput.addEventListener("input", debouncedSaveRecord);
      notasInput.addEventListener("input", debouncedSaveRecord);

      moodOptions.forEach(opt => {
          const radio = opt.querySelector('input[name="estadoAnimo"]');
          opt.addEventListener("click", () => {
              if (isFamiliaView) return;
              setMoodUI(radio.value);
              saveCurrentRecord();
          });
      });
      
      resetDiaBtn.addEventListener("click", () => {
          const ok = window.confirm("¬øSeguro que quer√©s borrar este turno completo?");
          if (!ok) return;
          resetCurrentRecord();
      });
      
      exportDiaBtn.addEventListener("click", () => {
          const fecha = fechaInput.value || hoyISO();
          const url = `${API_BASE}/exportar-csv?fecha=${encodeURIComponent(fecha)}`;
          window.open(url, "_blank");
      });
      
      btnTurnoAhora.addEventListener("click", () => {
          sugerirTurnoYCuidadorSegunAhora();
          loadCurrentRecord();
      });
      
      if (tabTurno && tabLista) {
          tabTurno.addEventListener("click", activarTabTurno);
          tabLista.addEventListener("click", activarTabLista);
          activarTabTurno();
      }

      // --- ALTA DESDE EL FORMULARIO (NUEVA L√ìGICA) ---
      if (listaAgregarBtn) {
        listaAgregarBtn.addEventListener("click", async () => {
          const categoria = listaCategoria.value;
          const producto  = listaProducto.value.trim();
          const cantidad  = listaCantidad.value.trim();
      
          if (!categoria || !producto || !cantidad) {
            alert("Complet√° categor√≠a, producto y cantidad.");
            return;
          }
      
          try {
            // Usamos el cuidador seleccionado en el formulario como 'creadoPor'
            const creadoPor = cuidadorSelect ? cuidadorSelect.value : 'otro';
            const nuevo = await apiListaAgregar({ categoria, producto, cantidad, creadoPor });
            listaComprasData.push(nuevo);
            listaProducto.value = "";
            listaCantidad.value = "";
            renderListaCompras();
          } catch (err) {
            console.error(err);
            alert("No se pudo agregar a la lista.");
          }
        });
      }
      // ------------------------------------------------

      setupLimpiarComprados();
      aplicarModoFamilia();
      await actualizarEstadosVisuales();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
