<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>TERES APP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Favicon emoji üëµüèª -->
  <link
    rel="icon"
    type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='80'%3Eüëµüèª%3C/text%3E%3C/svg%3E"
  >

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #222;
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      font-size: 1.5rem;
      margin: 4px 0 4px;
      text-align: center;
    }

    .subtitle {
      font-size: 0.9rem;
      text-align: center;
      color: #666;
      margin-bottom: 8px;
    }

    .date-label {
      font-size: 0.8rem;
      text-align: center;
      color: #777;
      margin-bottom: 16px;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    }

    .card h2 {
      font-size: 1rem;
      margin: 0 0 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
    }

    .row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 8px;
    }

    label {
      font-size: 0.85rem;
      font-weight: 500;
    }

    input[type="date"],
    select,
    input[type="number"],
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .two-cols {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .checkbox-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 10px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
    }

    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .status-pill {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eee;
      color: #444;
      white-space: nowrap;
    }

    .status-ok {
      background: #d4f5dd;
      color: #19692c;
    }

    .status-pending {
      background: #ffe7c7;
      color: #8a4b00;
    }

    .status-bad {
      background: #ffd6d6;
      color: #8a0000;
    }

    .day-status-panel {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .day-status-icon {
      font-size: 1.4rem;
    }

    .small-text {
      font-size: 0.8rem;
      color: #666;
    }

    .footer-info {
      text-align: center;
      font-size: 0.75rem;
      color: #999;
      margin-top: 8px;
    }

    .saved-message {
      font-size: 0.8rem;
      color: #19692c;
      text-align: right;
      min-height: 1em;
      opacity: 0;
      transition: opacity 0.25s ease;
    }

    .saved-message.visible {
      opacity: 1;
    }

    button.reset-btn {
      width: 100%;
      margin-top: 6px;
      padding: 11px;
      border-radius: 999px;
      border: none;
      font-size: 0.95rem;
      background: #ffe5e5;
      color: #a00000;
      cursor: pointer;
    }

    button.reset-btn:active {
      opacity: 0.8;
    }

    button.export-btn {
      width: 100%;
      margin-top: 8px;
      padding: 11px;
      border-radius: 999px;
      border: none;
      font-size: 0.95rem;
      background: #e6f0ff;
      color: #003f8c;
      cursor: pointer;
    }

    button.export-btn:active {
      opacity: 0.85;
    }

    /* Bot√≥n borrar historial */
    .delete-button {
      margin-top: 4px;
      align-self: flex-end;
      font-size: 0.7rem;
      padding: 5px 9px;
      border-radius: 999px;
      border: none;
      background: #ffe5e5;
      color: #a00000;
      cursor: pointer;
    }

    .delete-button:active {
      opacity: 0.8;
    }

    /* Historial */
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 260px;
      overflow-y: auto;
    }

    .history-day {
      border-radius: 10px;
      border: 1px solid #eee;
      padding: 6px 8px;
      background: #fafafa;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .history-day-header {
      font-size: 0.78rem;
      font-weight: 600;
      color: #444;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .history-day-summary {
      font-size: 0.75rem;
      color: #666;
    }

    .history-day-items {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 4px;
    }

    .history-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: 8px 8px;
      border-radius: 8px;
      border: 1px solid #eee;
      background: #ffffff;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .history-item-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .history-title {
      font-weight: 600;
    }

    .history-meta {
      font-size: 0.75rem;
      color: #555;
    }

    .history-summary {
      font-size: 0.75rem;
      color: #444;
    }

    .history-item:active {
      opacity: 0.7;
    }

    .history-item-empty {
      border-color: #ffb3b3;
      background: #fff0f0;
    }

    .history-item-incomplete {
      border-color: #ffe0b3;
      background: #fff8ee;
    }

    .badge {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eee;
    }

    /* Estado de √°nimo */
    .mood-group {
      display: flex;
      gap: 8px;
    }

    .mood-option {
      flex: 1;
      border-radius: 12px;
      border: 1px solid #ddd;
      padding: 9px 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      font-size: 0.8rem;
      cursor: pointer;
      user-select: none;
      background: #fafafa;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
      transition: background 0.15s ease, transform 0.15s ease, box-shadow 0.15s ease;
    }

    .mood-option input {
      display: none;
    }

    .mood-option.selected {
      border-color: #19692c;
      background: #e5f7ea;
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    }

    .mood-emoji {
      font-size: 1.7rem;
      line-height: 1;
    }

    .mood-label {
      font-size: 0.8rem;
    }

    /* Calendario de turnos ‚Äì versi√≥n simple y prolija */
    .schedule-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      margin-top: 4px;
      border: 1px solid #ddd;
    }

    .schedule-table th,
    .schedule-table td {
      padding: 4px 8px;
      border: 1px solid #eee;
      vertical-align: top;
    }

    .schedule-table th {
      background: #f7f7f7;
      font-weight: 600;
      text-align: left;
    }

    .schedule-table td:first-child {
      width: 80px;
      font-weight: 600;
      text-align: left;
      white-space: nowrap;
    }

    .schedule-table td:last-child {
      text-align: left;
    }

    .schedule-table td strong {
      font-weight: 700;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>üëµüèª TERE - Registro de cuidado</h1>
    <div class="subtitle">
      <em>
        Registro diario por turno<br>
        (comidas, agua, medicaci√≥n y estado de √°nimo)
      </em>
    </div>
    <div id="currentDateLabel" class="date-label"></div>

    <!-- Datos generales -->
    <div class="card">
      <h2>üìÖ Datos del turno</h2>
      <div class="two-cols">
        <div class="row">
          <label for="fecha">Fecha</label>
          <input type="date" id="fecha">
        </div>
        <div class="row">
          <label for="turno">Turno</label>
          <select id="turno">
            <option value="maniana">Ma√±ana</option>
            <option value="tarde">Tarde</option>
            <option value="noche">Noche</option>
            <option value="completo">24 hs</option>
          </select>
        </div>
      </div>
      <div class="row">
        <label for="cuidador">Cuidadora</label>
        <select id="cuidador">
          <option value="guadalupe">Guadalupe</option>
          <option value="aylen">Ayl√©n</option>
          <option value="noelia">Noelia</option>
          <option value="rocio">Roc√≠o</option>
          <option value="otro">Familiar / Otro</option>
        </select>
      </div>
      <div class="small-text" id="suggestInfo"></div>
      <div class="saved-message" id="savedMessage"></div>
      <div class="small-text" id="turnoInfo"></div>
    </div>

    <!-- Comidas -->
    <div class="card">
      <h2>
        üç≥‚Äã Comidas del d√≠a
        <span id="statusComidas" class="status-pill"></span>
      </h2>
      <div class="checkbox-grid">
        <label class="checkbox-item">
          <input type="checkbox" id="desayuno">
          <span>Desayuno</span>
        </label>
        <label class="checkbox-item">
          <input type="checkbox" id="almuerzo">
          <span>Almuerzo</span>
        </label>
        <label class="checkbox-item">
          <input type="checkbox" id="merienda">
          <span>Merienda</span>
        </label>
        <label class="checkbox-item">
          <input type="checkbox" id="cena">
          <span>Cena</span>
        </label>
      </div>
      <div class="small-text">Tildar en el turno en el que se realiza cada comida.</div>
    </div>

    <!-- Agua -->
    <div class="card">
      <h2>üíß Agua (d√≠a completo)</h2>
      <div class="row">
        <label for="aguaVasos">Vasos tomados en el d√≠a</label>
        <input type="number" id="aguaVasos" min="0" max="40" step="1" inputmode="numeric">
      </div>
      <div class="small-text">Actualizar a lo largo del d√≠a. Se consolida entre turnos.</div>
    </div>

    <!-- Medicaci√≥n -->
    <div class="card">
      <h2>
        üíä Medicaci√≥n del d√≠a
        <span id="statusMed" class="status-pill"></span>
      </h2>
      <div class="checkbox-grid">
        <label class="checkbox-item">
          <input type="checkbox" id="medManiana">
          <span>Ma√±ana</span>
        </label>
        <label class="checkbox-item">
          <input type="checkbox" id="medNoche">
          <span>Noche</span>
        </label>
      </div>
      <div class="small-text">
        La pastilla de la ma√±ana y de la noche deben estar marcadas para considerar el d√≠a completo.
      </div>
    </div>

    <!-- Estado de √°nimo -->
    <div class="card">
      <h2>Estado de √°nimo (turno)</h2>
      <div class="mood-group">
        <label class="mood-option">
          <input type="radio" name="estadoAnimo" value="bien">
          <span class="mood-emoji">üôÇ</span>
          <span class="mood-label">Bien</span>
        </label>
        <label class="mood-option">
          <input type="radio" name="estadoAnimo" value="neutral">
          <span class="mood-emoji">üòê</span>
          <span class="mood-label">Normal</span>
        </label>
        <label class="mood-option">
          <input type="radio" name="estadoAnimo" value="mal">
          <span class="mood-emoji">üòü</span>
          <span class="mood-label">Mal</span>
        </label>
      </div>
      <div class="small-text">Elegir el estado de √°nimo predominante en este turno.</div>
    </div>

    <!-- Notas -->
    <div class="card">
      <h2>üìù Notas del turno</h2>
      <div class="row">
        <label for="notas">Observaciones</label>
        <textarea id="notas" placeholder="Ej: comi√≥ poco, se quej√≥ de dolor, durmi√≥ bien/mal, etc."></textarea>
      </div>
      <button class="reset-btn" id="resetDia">Borrar registro de este turno</button>
    </div>

    <!-- Estado general d√≠a -->
    <div class="card">
      <h2>Resumen r√°pido del d√≠a</h2>
      <div class="day-status-panel">
        <span class="day-status-icon">ü©∫</span>
        <span id="statusDia" class="status-pill"></span>
      </div>
      <div id="resumenTexto" class="small-text"></div>
    </div>

    <!-- Historial -->
    <div class="card">
      <h2>Historial reciente</h2>
      <div class="small-text" style="margin-bottom:4px;">
        Ver √∫ltimos turnos registrados. Toc√° un √≠tem para cargarlo en el formulario.<br>
        El resumen se consolida por d√≠a (comidas, medicaci√≥n y agua).
      </div>
      <div class="small-text" style="margin-bottom:6px;">
        <span style="display:inline-flex;align-items:center;gap:4px;margin-right:8px;">
          <span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:#fff0f0;border:1px solid #ffb3b3;"></span>
          Turno vac√≠o
        </span>
        <span style="display:inline-flex;align-items:center;gap:4px;">
          <span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:#fff8ee;border:1px solid #ffe0b3;"></span>
          Turno incompleto
        </span>
      </div>
      <div id="historialLista" class="history-list"></div>
    </div>

    <!-- Calendario de turnos -->
    <div class="card">
      <h2>üóìÔ∏è‚Äã Calendario de turnos</h2>
      <div class="small-text">Referencia seg√∫n el cronograma acordado.</div>
      <table class="schedule-table">
        <thead>
          <tr>
            <th>D√≠a</th>
            <th>Horarios y cuidadores</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Lunes</td>
            <td>
              12:00 a 18:00 ‚Äî <strong>GUADA</strong><br>
              20:00 a 08:00 ‚Äî <strong>NOELIA</strong> <small>(hasta el martes)</small>
            </td>
          </tr>
          <tr>
            <td>Martes</td>
            <td>
              12:00 a 16:00 ‚Äî <strong>AYL√âN</strong><br>
              21:00 a 12:00 ‚Äî <strong>GUADA</strong> <small>(hasta el mi√©rcoles)</small>
            </td>
          </tr>
          <tr>
            <td>Mi√©rcoles</td>
            <td>
              12:00 a 18:00 ‚Äî <strong>GUADA</strong><br>
              20:00 a 08:00 ‚Äî <strong>NOELIA</strong> <small>(hasta el jueves)</small>
            </td>
          </tr>
          <tr>
            <td>Jueves</td>
            <td>
              12:00 a 16:00 ‚Äî <strong>AYL√âN</strong><br>
              20:00 a 08:00 ‚Äî <strong>NOELIA</strong> <small>(hasta el viernes)</small>
            </td>
          </tr>
          <tr>
            <td>Viernes</td>
            <td>
              09:00 a 18:00 ‚Äî <strong>GUADA</strong><br>
              20:00 a 08:00 ‚Äî <strong>NOELIA</strong> <small>(hasta el s√°bado)</small>
            </td>
          </tr>
          <tr>
            <td>S√°bado</td>
            <td>
              20:00 a 08:00 ‚Äî <strong>ROC√çO</strong> <small>(hasta el domingo)</small>
            </td>
          </tr>
          <tr>
            <td>Domingo</td>
            <td>
              19:00 a 08:00 ‚Äî <strong>ROC√çO</strong> <small>(hasta el lunes)</small>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Exportar (al fondo) -->
    <div class="card">
      <h2>Exportar registros</h2>
      <button class="export-btn" id="exportDia">‚¨áÔ∏è Exportar d√≠a a Excel / Sheets</button>
      <div class="small-text">Genera un CSV con todos los turnos del d√≠a seleccionado.</div>
    </div>

    <div class="footer-info">
      Developed by Cundo.NET
    </div>
  </div>

  <script>
    const API_BASE = "/api";

    async function apiGuardar(record) {
      const res = await fetch(API_BASE + "/guardar-registro", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(record)
      });
      if (!res.ok) throw new Error("Error al guardar registro");
      try { return await res.json(); } catch { return {}; }
    }

    async function apiListar(params = {}) {
      const url = new URL(API_BASE + "/listar-registros", window.location.origin);
      Object.entries(params).forEach(([k, v]) => {
        if (v !== undefined && v !== null && v !== "") {
          url.searchParams.set(k, v);
        }
      });
      const res = await fetch(url.toString());
      if (!res.ok) throw new Error("Error al leer registros");
      return await res.json();
    }

    async function apiBorrar(id) {
      const url = new URL(API_BASE + "/borrar-registro", window.location.origin);
      url.searchParams.set("id", id);
      const res = await fetch(url.toString(), { method: "POST" });
      if (!res.ok) throw new Error("Error al borrar registro");
      return await res.json();
    }

    const fechaInput       = document.getElementById("fecha");
    const turnoSelect      = document.getElementById("turno");
    const cuidadorSelect   = document.getElementById("cuidador");
    const desayunoInput    = document.getElementById("desayuno");
    const almuerzoInput    = document.getElementById("almuerzo");
    const meriendaInput    = document.getElementById("merienda");
    const cenaInput        = document.getElementById("cena");
    const aguaInput        = document.getElementById("aguaVasos");
    const medManianaInput  = document.getElementById("medManiana");
    const medNocheInput    = document.getElementById("medNoche");
    const notasInput       = document.getElementById("notas");
    const statusComidas    = document.getElementById("statusComidas");
    const statusMed        = document.getElementById("statusMed");
    const statusDia        = document.getElementById("statusDia");
    const resumenTexto     = document.getElementById("resumenTexto");
    const savedMessage     = document.getElementById("savedMessage");
    const resetDiaBtn      = document.getElementById("resetDia");
    const historialLista   = document.getElementById("historialLista");
    const suggestInfo      = document.getElementById("suggestInfo");
    const turnoInfo        = document.getElementById("turnoInfo");
    const exportDiaBtn     = document.getElementById("exportDia");
    const currentDateLabel = document.getElementById("currentDateLabel");

    const moodOptions      = document.querySelectorAll(".mood-option");
    const moodRadios       = document.querySelectorAll('input[name="estadoAnimo"]');

    let saveTimeout = null;
    let lastCuidadorValue = cuidadorSelect.value;
    let lastTurnoValue    = turnoSelect.value;

    const schedule = {
      1: [
        { from: 0,        to: 8 * 60,  cuidador: "rocio"     },
        { from: 12 * 60,  to: 18 * 60, cuidador: "guadalupe" },
        { from: 20 * 60,  to: 24 * 60, cuidador: "noelia"    }
      ],
      2: [
        { from: 0,        to: 8 * 60,  cuidador: "noelia"    },
        { from: 12 * 60,  to: 16 * 60, cuidador: "aylen"     },
        { from: 21 * 60,  to: 24 * 60, cuidador: "guadalupe" }
      ],
      3: [
        { from: 0,        to: 12 * 60, cuidador: "guadalupe" },
        { from: 12 * 60,  to: 18 * 60, cuidador: "guadalupe" },
        { from: 20 * 60,  to: 24 * 60, cuidador: "noelia"    }
      ],
      4: [
        { from: 0,        to: 8 * 60,  cuidador: "noelia"    },
        { from: 12 * 60,  to: 16 * 60, cuidador: "aylen"     },
        { from: 20 * 60,  to: 24 * 60, cuidador: "noelia"    }
      ],
      5: [
        { from: 0,        to: 8 * 60,  cuidador: "noelia"    },
        { from: 9 * 60,   to: 18 * 60, cuidador: "guadalupe" },
        { from: 20 * 60,  to: 24 * 60, cuidador: "noelia"    }
      ],
      6: [
        { from: 0,        to: 8 * 60,  cuidador: "noelia"    },
        { from: 20 * 60,  to: 24 * 60, cuidador: "rocio"     }
      ],
      0: [
        { from: 0,        to: 8 * 60,  cuidador: "rocio"     },
        { from: 19 * 60,  to: 24 * 60, cuidador: "rocio"     }
      ]
    };

    function hoyISO() {
      const hoy = new Date();
      const y = hoy.getFullYear();
      const m = String(hoy.getMonth() + 1).padStart(2, "0");
      const d = String(hoy.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function formatFecha(fechaStr) {
      if (!fechaStr) return "-";
      const base = fechaStr.slice(0, 10);
      const [y, m, d] = base.split("-");
      if (!y || !m || !d) return fechaStr;
      return `${d}/${m}/${y}`;
    }

    function getNowInfo() {
      const now = new Date();
      const dow = now.getDay();
      const minutes = now.getHours() * 60 + now.getMinutes();
      return { dow, minutes };
    }

    function getCaregiverFor(dow, minutes) {
      const daySched = schedule[dow] || [];
      for (const slot of daySched) {
        if (minutes >= slot.from && minutes < slot.to) return slot.cuidador;
      }
      return null;
    }

    function getScheduledCuidadorForFechaTurno(fechaStr, turno) {
      const base = fechaStr || hoyISO();
      const fecha = new Date(base + "T12:00:00");
      const dow = fecha.getDay();

      let minutes;
      switch (turno) {
        case "maniana":
          minutes = 9 * 60;
          break;
        case "tarde":
          minutes = 15 * 60;
          break;
        case "noche":
          minutes = 22 * 60;
          break;
        case "completo":
        default:
          minutes = 12 * 60;
      }
      return getCaregiverFor(dow, minutes);
    }

    function guessTurnoFromMinutes(minutes) {
      if (minutes >= 6 * 60 && minutes < 12 * 60) return "maniana";
      if (minutes >= 12 * 60 && minutes < 20 * 60) return "tarde";
      return "noche";
    }

    function getSelectedMood() {
      let value = "";
      moodRadios.forEach(r => { if (r.checked) value = r.value; });
      return value;
    }

    function setMoodUI(value) {
      moodOptions.forEach(opt => {
        const radio = opt.querySelector('input[name="estadoAnimo"]');
        const match = radio.value === value;
        radio.checked = match;
        opt.classList.toggle("selected", match);
      });
    }

    function clearMoodUI() {
      setMoodUI("");
    }

    function moodEmoji(value) {
      if (value === "bien") return "üôÇ";
      if (value === "neutral") return "üòê";
      if (value === "mal") return "üòü";
      return "";
    }

    function labelCuidador(value) {
      switch (value) {
        case "guadalupe": return "Guadalupe";
        case "aylen":     return "Ayl√©n";
        case "noelia":    return "Noelia";
        case "rocio":     return "Roc√≠o";
        case "otro":      return "Familiar / Otro";
        default:          return value;
      }
    }

    function labelTurno(value) {
      switch (value) {
        case "maniana": return "Ma√±ana";
        case "tarde":   return "Tarde";
        case "noche":   return "Noche";
        case "completo":return "24 hs";
        default:        return value || "-";
      }
    }

    function getHoraDesdeRec(rec) {
      const raw = rec.created_at || rec.hora || rec.fecha_hora;
      if (!raw) return "";
      const date = new Date(raw);
      if (isNaN(date.getTime())) return "";
      const hh = String(date.getHours()).padStart(2, "0");
      const mm = String(date.getMinutes()).padStart(2, "0");
      return `${hh}:${mm} hs`;
    }

    function mostrarGuardado() {
      const ahora = new Date();
      const hh = String(ahora.getHours()).padStart(2, "0");
      const mm = String(ahora.getMinutes()).padStart(2, "0");
      savedMessage.textContent = `Guardado en TERE ‚úÖ ${hh}:${mm}`;
      savedMessage.classList.add("visible");
      if (saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        savedMessage.classList.remove("visible");
      }, 1500);
    }

    async function fetchRecordForCurrentKey() {
      const fecha = fechaInput.value || hoyISO();
      const cuidador = cuidadorSelect.value;
      const turno = turnoSelect.value;

      const rows = await apiListar({ fecha, cuidador, turno });
      if (!rows || rows.length === 0) return null;

      const r = rows[0];

      return {
        fecha,
        turno,
        cuidador,
        desayuno: !!r.desayuno,
        almuerzo: !!r.almuerzo,
        merienda: !!r.merienda,
        cena: !!r.cena,
        aguaVasos: r.agua_vasos ?? 0,
        medManiana: !!r.med_maniana,
        medNoche: !!r.med_noche,
        notas: r.notas || "",
        estadoAnimo: r.estado_animo || ""
      };
    }

    async function getDailySummary(fechaStr) {
      const registros = await apiListar({ fecha: fechaStr });

      const result = {
        desayuno: false,
        almuerzo: false,
        merienda: false,
        cena: false,
        medManiana: false,
        medNoche: false,
        aguaVasos: 0,
        turnos: 0
      };

      registros.forEach(rec => {
        result.turnos += 1;
        if (rec.desayuno)      result.desayuno = true;
        if (rec.almuerzo)      result.almuerzo = true;
        if (rec.merienda)      result.merienda = true;
        if (rec.cena)          result.cena = true;
        if (rec.med_maniana)   result.medManiana = true;
        if (rec.med_noche)     result.medNoche = true;
        const agua = rec.agua_vasos || 0;
        if (agua > result.aguaVasos) result.aguaVasos = agua;
      });

      return result;
    }

    async function saveCurrentRecord() {
      const record = {
        fecha: fechaInput.value || hoyISO(),
        turno: turnoSelect.value,
        cuidador: cuidadorSelect.value,
        desayuno: desayunoInput.checked,
        almuerzo: almuerzoInput.checked,
        merienda: meriendaInput.checked,
        cena: cenaInput.checked,
        aguaVasos: parseInt(aguaInput.value || "0", 10),
        medManiana: medManianaInput.checked,
        medNoche: medNocheInput.checked,
        notas: notasInput.value || "",
        estadoAnimo: getSelectedMood()
      };

      try {
        await apiGuardar(record);
        mostrarGuardado();
        await actualizarEstadosVisuales();
        await buildHistory();
      } catch (e) {
        console.error(e);
        alert("No se pudo guardar en la base central. Revisar conexi√≥n.");
      }
    }

    async function loadCurrentRecord() {
      try {
        const rec = await fetchRecordForCurrentKey();
        if (rec) {
          desayunoInput.checked   = rec.desayuno;
          almuerzoInput.checked   = rec.almuerzo;
          meriendaInput.checked   = rec.merienda;
          cenaInput.checked       = rec.cena;
          aguaInput.value         = rec.aguaVasos || "";
          medManianaInput.checked = rec.medManiana;
          medNocheInput.checked   = rec.medNoche;
          notasInput.value        = rec.notas || "";
          setMoodUI(rec.estadoAnimo);
          turnoInfo.textContent   = "Turno ya registrado. Est√°s editando la informaci√≥n guardada.";
        } else {
          desayunoInput.checked   = false;
          almuerzoInput.checked   = false;
          meriendaInput.checked   = false;
          cenaInput.checked       = false;
          aguaInput.value         = "";
          medManianaInput.checked = false;
          medNocheInput.checked   = false;
          notasInput.value        = "";
          clearMoodUI();
          turnoInfo.textContent   = "Turno nuevo para este d√≠a y horario.";
        }
        await actualizarEstadosVisuales();
      } catch (e) {
        console.error(e);
      }
    }

    async function resetCurrentRecord() {
      desayunoInput.checked   = false;
      almuerzoInput.checked   = false;
      meriendaInput.checked   = false;
      cenaInput.checked       = false;
      aguaInput.value         = "";
      medManianaInput.checked = false;
      medNocheInput.checked   = false;
      notasInput.value        = "";
      clearMoodUI();
      await saveCurrentRecord();
    }

    async function actualizarEstadosVisuales() {
      const anyMeal = desayunoInput.checked || almuerzoInput.checked ||
                      meriendaInput.checked || cenaInput.checked;
      const allMeals = desayunoInput.checked && almuerzoInput.checked &&
                       meriendaInput.checked && cenaInput.checked;

      // Estado de comidas (turno)
      statusComidas.classList.remove("status-ok", "status-pending", "status-bad");
      if (allMeals) {
        statusComidas.textContent = "Comidas completas (turno)";
        statusComidas.classList.add("status-ok");
      } else if (anyMeal) {
        statusComidas.textContent = "Comidas incompletas (turno)";
        statusComidas.classList.add("status-pending");
      } else {
        statusComidas.textContent = "Sin comidas registradas en este turno";
        statusComidas.classList.add("status-pending");
      }

      const medAny = medManianaInput.checked || medNocheInput.checked;
      const medAll = medManianaInput.checked && medNocheInput.checked;

      statusMed.classList.remove("status-ok", "status-pending", "status-bad");
      if (medAll) {
        statusMed.textContent = "Medicaci√≥n completa (turno)";
        statusMed.classList.add("status-ok");
      } else if (medAny) {
        statusMed.textContent = "Medicaci√≥n incompleta (turno)";
        statusMed.classList.add("status-pending");
      } else {
        statusMed.textContent = "Sin medicaci√≥n registrada en este turno";
        statusMed.classList.add("status-pending");
      }

      const fechaDia = fechaInput.value || hoyISO();
      try {
        const daily = await getDailySummary(fechaDia);
        const partes = [];

        const todasComidasDia = daily.desayuno && daily.almuerzo &&
                                daily.merienda && daily.cena;

        if (todasComidasDia) {
          partes.push("‚úÖ Todas las comidas del d√≠a registradas (desayuno, almuerzo, merienda y cena).");
        } else {
          const faltantes = [];
          if (!daily.desayuno) faltantes.push("desayuno");
          if (!daily.almuerzo) faltantes.push("almuerzo");
          if (!daily.merienda) faltantes.push("merienda");
          if (!daily.cena)     faltantes.push("cena");
          partes.push(`‚ö†Ô∏è Faltan comidas por registrar: ${faltantes.join(", ")}.`);
        }

        if (daily.medManiana && daily.medNoche) {
          partes.push("‚úÖ Medicaci√≥n del d√≠a completa (ma√±ana y noche registradas en al menos un turno).");
        } else if (daily.medManiana || daily.medNoche) {
          partes.push("‚ö†Ô∏è Medicaci√≥n incompleta (s√≥lo una franja registrada).");
        } else {
          partes.push("‚ö†Ô∏è No se registr√≥ medicaci√≥n para este d√≠a.");
        }

        const vasos = daily.aguaVasos || 0;
        if (vasos > 0) {
          partes.push(`üíß Se registraron ${vasos} vaso(s) de agua en el d√≠a (valor consolidado).`);
        } else {
          partes.push("üíß No se registr√≥ agua para este d√≠a.");
        }

        if (daily.turnos > 0) {
          partes.push(`üìã Turnos registrados en el d√≠a: ${daily.turnos}.`);
        } else {
          partes.push("üìã A√∫n no hay turnos registrados para este d√≠a.");
        }

        resumenTexto.textContent = partes.join(" ");

        // Estado general del d√≠a (pill)
        statusDia.classList.remove("status-ok", "status-pending", "status-bad");
        if (daily.turnos === 0) {
          statusDia.textContent = "Sin datos";
          statusDia.classList.add("status-bad");
        } else {
          const diaCompleto =
            todasComidasDia &&
            daily.medManiana && daily.medNoche &&
            (daily.aguaVasos >= 6); // sugerencia m√≠nima de agua

          if (diaCompleto) {
            statusDia.textContent = "D√≠a completo";
            statusDia.classList.add("status-ok");
          } else {
            statusDia.textContent = "D√≠a incompleto";
            statusDia.classList.add("status-pending");
          }
        }
      } catch (e) {
        console.error(e);
        resumenTexto.textContent = "No se pudo obtener el resumen diario (problema de conexi√≥n).";
        statusDia.textContent = "";
        statusDia.classList.remove("status-ok", "status-pending", "status-bad");
      }
    }

    async function buildHistory() {
      try {
        const registros = await apiListar({ limite: 100 });

        if (!registros || registros.length === 0) {
          historialLista.innerHTML = "<div class='small-text'>Sin registros todav√≠a.</div>";
          return;
        }

        // Agrupamos primero por fecha (d√≠a)
        const porDia = new Map();

        registros.forEach(rec => {
          const fechaStr = typeof rec.fecha === "string" ? rec.fecha.slice(0, 10) : rec.fecha;
          if (!porDia.has(fechaStr)) {
            porDia.set(fechaStr, []);
          }
          porDia.get(fechaStr).push(rec);
        });

        // Ordenamos d√≠as de m√°s reciente a m√°s viejo
        const diasOrdenados = Array.from(porDia.entries()).sort((a, b) => {
          return a[0] < b[0] ? 1 : -1; // yyyy-mm-dd, orden descendente
        });

        historialLista.innerHTML = "";

        diasOrdenados.forEach(([fechaStr, recsDia]) => {
          // Resumen diario
          let resumenDia = {
            desayuno: false,
            almuerzo: false,
            merienda: false,
            cena: false,
            medManiana: false,
            medNoche: false,
            aguaVasos: 0,
            turnos: 0
          };

          recsDia.forEach(r => {
            resumenDia.turnos += 1;
            if (r.desayuno)    resumenDia.desayuno = true;
            if (r.almuerzo)    resumenDia.almuerzo = true;
            if (r.merienda)    resumenDia.merienda = true;
            if (r.cena)        resumenDia.cena = true;
            if (r.med_maniana) resumenDia.medManiana = true;
            if (r.med_noche)   resumenDia.medNoche = true;
            const agua = r.agua_vasos || 0;
            if (agua > resumenDia.aguaVasos) resumenDia.aguaVasos = agua;
          });

          const todasComidasDia = resumenDia.desayuno && resumenDia.almuerzo &&
                                  resumenDia.merienda && resumenDia.cena;

          const estadoComidasDia = todasComidasDia
            ? "Comidas completas"
            : "Comidas incompletas";

          let estadoMedDia;
          if (resumenDia.medManiana && resumenDia.medNoche) {
            estadoMedDia = "Medicaci√≥n completa";
          } else if (resumenDia.medManiana || resumenDia.medNoche) {
            estadoMedDia = "Medicaci√≥n incompleta";
          } else {
            estadoMedDia = "Sin medicaci√≥n registrada";
          }

          const diaContainer = document.createElement("div");
          diaContainer.className = "history-day";

          const header = document.createElement("div");
          header.className = "history-day-header";
          header.textContent = formatFecha(fechaStr);

          const headerSummary = document.createElement("div");
          headerSummary.className = "history-day-summary";
          headerSummary.textContent =
            `${estadoComidasDia} ¬∑ ${estadoMedDia} ¬∑ Agua: ${resumenDia.aguaVasos} vaso(s) ¬∑ Turnos: ${resumenDia.turnos}`;

          header.appendChild(headerSummary);
          diaContainer.appendChild(header);

          const itemsContainer = document.createElement("div");
          itemsContainer.className = "history-day-items";

          // Dentro del d√≠a, consolidamos por turno+cuidador para evitar duplicados
          const agrupados = new Map();
          recsDia.forEach(rec => {
            const key = `${rec.turno}|${rec.cuidador}`;
            if (!agrupados.has(key)) {
              agrupados.set(key, rec);
            }
          });

          const turnosDia = Array.from(agrupados.values());

          // Ordenamos turnos dentro del d√≠a (ma√±ana, tarde, noche, completo)
          const ordenTurno = { maniana: 0, tarde: 1, noche: 2, completo: 3 };
          turnosDia.sort((a, b) => {
            const ta = ordenTurno[a.turno] ?? 99;
            const tb = ordenTurno[b.turno] ?? 99;
            return ta - tb;
          });

          turnosDia.forEach(rec => {
            const comidasCount =
              (rec.desayuno ? 1 : 0) +
              (rec.almuerzo ? 1 : 0) +
              (rec.merienda ? 1 : 0) +
              (rec.cena ? 1 : 0);

            const medCount =
              (rec.med_maniana ? 1 : 0) +
              (rec.med_noche ? 1 : 0);

            const agua = rec.agua_vasos ?? 0;
            const mood = moodEmoji(rec.estado_animo);
            const hora = getHoraDesdeRec(rec);

            const item = document.createElement("div");
            item.className = "history-item";

            // Resaltamos turnos "vac√≠os" o incompletos
            const turnoVacio = comidasCount === 0 && medCount === 0;
            const turnoIncompleto = !turnoVacio && (comidasCount < 4 || medCount < 2);

            if (turnoVacio) {
              item.classList.add("history-item-empty");
            } else if (turnoIncompleto) {
              item.classList.add("history-item-incomplete");
            }

            const main  = document.createElement("div");
            main.className = "history-item-main";

            const title = document.createElement("div");
            title.className = "history-title";
            title.textContent = `${labelTurno(rec.turno)}${mood ? " " + mood : ""}`;

            const badge = document.createElement("div");
            badge.className = "badge";
            badge.textContent = hora
              ? `${labelCuidador(rec.cuidador)} ¬∑ ${hora}`
              : labelCuidador(rec.cuidador);

            main.appendChild(title);
            main.appendChild(badge);

            const meta = document.createElement("div");
            meta.className = "history-meta";
            meta.textContent = rec.notas
              ? `Notas: ${rec.notas.slice(0, 60)}${rec.notas.length > 60 ? "..." : ""}`
              : "Sin notas.";

            const summary = document.createElement("div");
            summary.className = "history-summary";
            summary.textContent =
              `Comidas: ${comidasCount}/4 ¬∑ Med: ${medCount}/2 ¬∑ Agua: ${agua} vaso(s)`;

            item.appendChild(main);
            item.appendChild(summary);

            const deleteBtn = document.createElement("button");
            deleteBtn.className = "delete-button";
            deleteBtn.textContent = "Borrar";
            deleteBtn.addEventListener("click", async (e) => {
              e.stopPropagation();
              try {
                await apiBorrar(rec.id);
                await buildHistory();
                await actualizarEstadosVisuales();
              } catch (err) {
                console.error(err);
              }
            });
            item.appendChild(deleteBtn);

            item.appendChild(meta);

            item.addEventListener("click", () => {
              fechaInput.value     = fechaStr || hoyISO();
              turnoSelect.value    = rec.turno || "maniana";
              cuidadorSelect.value = rec.cuidador || "otro";
              lastCuidadorValue    = cuidadorSelect.value;
              lastTurnoValue       = turnoSelect.value;
              suggestInfo.textContent = "";
              loadCurrentRecord();
              window.scrollTo({ top: 0, behavior: "smooth" });
            });

            itemsContainer.appendChild(item);
          });

          diaContainer.appendChild(itemsContainer);
          historialLista.appendChild(diaContainer);
        });
      } catch (e) {
        console.error(e);
        historialLista.innerHTML = "<div class='small-text'>No se pudo cargar el historial (problema de conexi√≥n).</div>";
      }
    }

    function sugerirTurnoYCuidadorSegunAhora() {
      const hoy = hoyISO();
      fechaInput.value = hoy;

      const { minutes } = getNowInfo();
      const turnoGuess = guessTurnoFromMinutes(minutes);
      turnoSelect.value = turnoGuess;
      lastTurnoValue = turnoGuess;

      const scheduled = getScheduledCuidadorForFechaTurno(hoy, turnoGuess);

      if (scheduled) {
        cuidadorSelect.value = scheduled;
        suggestInfo.textContent = "Cuidadora sugerida autom√°ticamente seg√∫n calendario del turno.";
      } else {
        suggestInfo.textContent = "Fuera de un turno fijo: seleccionar cuidadora manualmente.";
      }

      lastCuidadorValue = cuidadorSelect.value;
    }

    async function handleCuidadorChange() {
      const newValue = cuidadorSelect.value;
      const fechaSel = fechaInput.value || hoyISO();
      const turnoSel = turnoSelect.value;

      const scheduled = getScheduledCuidadorForFechaTurno(fechaSel, turnoSel);

      if (scheduled && newValue !== "otro" && newValue !== scheduled) {
        const nombreProgramado = labelCuidador(scheduled);
        const nombreNuevo      = labelCuidador(newValue);
        const ok = window.confirm(
          `${nombreNuevo} no est√° programada para este turno.\n` +
          `Seg√∫n el calendario deber√≠a estar ${nombreProgramado}.\n\n` +
          `¬øConfirm√°s que ${nombreNuevo} est√° cubriendo el turno de otra persona?`
        );
        if (!ok) {
          cuidadorSelect.value = lastCuidadorValue;
          return;
        }
      }

      lastCuidadorValue = newValue;
      suggestInfo.textContent = "";
      await loadCurrentRecord();
    }

    async function handleTurnoChange() {
      const fechaSel = fechaInput.value || hoyISO();
      const turnoSel = turnoSelect.value;
      const scheduled = getScheduledCuidadorForFechaTurno(fechaSel, turnoSel);

      if (scheduled && cuidadorSelect.value !== "otro" && cuidadorSelect.value !== scheduled) {
        const nombreProgramado = labelCuidador(scheduled);
        const nombreActual     = labelCuidador(cuidadorSelect.value);

        const ok = window.confirm(
          `${nombreActual} no est√° programada para este turno.\n` +
          `Seg√∫n el calendario deber√≠a estar ${nombreProgramado}.\n\n` +
          `¬øConfirm√°s que ${nombreActual} est√° cubriendo un horario distinto al asignado?`
        );

        if (!ok) {
          turnoSelect.value = lastTurnoValue;
          return;
        }
      }

      lastTurnoValue = turnoSel;

      if (scheduled) {
        suggestInfo.textContent = "Turno y cuidadora verificados seg√∫n el calendario.";
      } else {
        suggestInfo.textContent = "Turno fuera del calendario fijo. Verific√° que la persona est√© cubriendo este horario.";
      }

      await loadCurrentRecord();
    }

    async function init() {
      const hoyStr = hoyISO();
      fechaInput.max = hoyStr;

      // Etiqueta "Hoy: dd/mm/aaaa"
      currentDateLabel.textContent = "Hoy: " + formatFecha(hoyStr);

      sugerirTurnoYCuidadorSegunAhora();
      await loadCurrentRecord();
      await buildHistory();

      fechaInput.addEventListener("change", () => {
        const valor = fechaInput.value;
        const hoy = hoyISO();
        if (valor && valor > hoy) {
          alert("No se pueden registrar turnos en fechas futuras. Se usar√° la fecha de hoy.");
          fechaInput.value = hoy;
        }
        const actual = fechaInput.value || hoy;
        suggestInfo.textContent = "";
        currentDateLabel.textContent =
          actual && actual <= hoy ? "D√≠a seleccionado: " + formatFecha(actual)
                                  : "Hoy: " + formatFecha(hoy);
        loadCurrentRecord();
      });

      turnoSelect.addEventListener("change", () => {
        handleTurnoChange();
      });

      cuidadorSelect.addEventListener("change", () => {
        handleCuidadorChange();
      });

      [
        desayunoInput,
        almuerzoInput,
        meriendaInput,
        cenaInput,
        medManianaInput,
        medNocheInput
      ].forEach(el => el.addEventListener("change", () => { saveCurrentRecord(); }));

      aguaInput.addEventListener("input", () => { saveCurrentRecord(); });
      notasInput.addEventListener("input", () => { saveCurrentRecord(); });

      moodOptions.forEach(opt => {
        const radio = opt.querySelector('input[name="estadoAnimo"]');
        opt.addEventListener("click", () => {
          setMoodUI(radio.value);
          saveCurrentRecord();
        });
      });

      resetDiaBtn.addEventListener("click", () => { resetCurrentRecord(); });

      exportDiaBtn.addEventListener("click", () => {
        const fecha = fechaInput.value || hoyISO();
        const url = `${API_BASE}/exportar-csv?fecha=${encodeURIComponent(fecha)}`;
        window.open(url, "_blank");
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      init();
    });
  </script>
</body>
</html>
