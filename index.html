<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>TERES APP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Favicon emoji üëµüèª -->
  <link
    rel="icon"
    type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='80'%3Eüëµüèª%3C/text%3E%3C/svg%3E"
  >

  <style>
   
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #222;
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      font-size: 1.4rem;
      margin: 0 0 8px;
      text-align: center;
    }

    .subtitle {
      font-size: 0.9rem;
      text-align: center;
      color: #666;
      margin-bottom: 16px;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    }

    .card h2 {
      font-size: 1rem;
      margin: 0 0 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
    }

    .row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 8px;
    }

    label {
      font-size: 0.85rem;
      font-weight: 500;
    }

    input[type="date"],
    select,
    input[type="number"],
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .two-cols {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .checkbox-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 10px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
    }

    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .status-pill {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eee;
      color: #444;
      white-space: nowrap;
    }

    .status-ok {
      background: #d4f5dd;
      color: #19692c;
    }

    .status-pending {
      background: #ffe7c7;
      color: #8a4b00;
    }

    .small-text {
      font-size: 0.8rem;
      color: #666;
    }

    .footer-info {
      text-align: center;
      font-size: 0.75rem;
      color: #999;
      margin-top: 8px;
    }

    .saved-message {
      font-size: 0.8rem;
      color: #19692c;
      text-align: right;
      min-height: 1em;
    }

    button.reset-btn {
      width: 100%;
      margin-top: 6px;
      padding: 8px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      background: #ffe5e5;
      color: #a00000;
      cursor: pointer;
    }

    button.reset-btn:active {
      opacity: 0.8;
    }

    button.export-btn {
      width: 100%;
      margin-top: 8px;
      padding: 8px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      background: #e6f0ff;
      color: #003f8c;
      cursor: pointer;
    }

    button.export-btn:active {
      opacity: 0.85;
    }

    /* Historial */
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 260px;
      overflow-y: auto;
    }

    .history-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #eee;
      background: #fafafa;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .history-item-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .history-title {
      font-weight: 600;
    }

    .history-meta {
      font-size: 0.75rem;
      color: #555;
    }

    .history-summary {
      font-size: 0.75rem;
      color: #444;
    }

    .history-item:active {
      opacity: 0.7;
    }

    .badge {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eee;
    }

    /* Estado de √°nimo */
    .mood-group {
      display: flex;
      gap: 8px;
    }

    .mood-option {
      flex: 1;
      border-radius: 10px;
      border: 1px solid #ddd;
      padding: 6px 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      font-size: 0.8rem;
      cursor: pointer;
      user-select: none;
      background: #fafafa;
    }

    .mood-option input {
      display: none;
    }

    .mood-option.selected {
      border-color: #19692c;
      background: #e5f7ea;
    }

    .mood-emoji {
      font-size: 1.5rem;
      line-height: 1;
    }

    .mood-label {
      font-size: 0.8rem;
    }

/* Calendario de turnos ‚Äì versi√≥n simple y prolija */
		.schedule-table {
		  width: 100%;
		  border-collapse: collapse;
		  font-size: 0.8rem;
		  margin-top: 4px;
		  border: 1px solid #ddd;
		}

		.schedule-table th,
		.schedule-table td {
		  padding: 4px 8px;
		  border: 1px solid #eee;
		  vertical-align: top;
		}

		/* Encabezados */
		.schedule-table th {
		  background: #f7f7f7;
		  font-weight: 600;
		  text-align: left;
		}

		/* Columna "D√≠a" m√°s angosta pero sin apretar el texto */
		.schedule-table td:first-child {
		  width: 80px;          /* Fijo, no porcentaje raro */
		  font-weight: 600;
		  text-align: left;
		  white-space: nowrap;  /* "Mi√©rcoles" no se corta en dos l√≠neas */
		}

		/* Columna de horarios ocupa el resto, texto alineado a la izquierda */
		.schedule-table td:last-child {
		  text-align: left;
		}

		/* Nombres en negrita suave */
		.schedule-table td strong {
		  font-weight: 700;
		}

  </style>
</head>
<body>
  <div class="app">
    <h1>üëµüèª TERE - Registro de cuidado</h1>
    <div class="subtitle">
  <em>
    Registro diario por turno<br>
    (comidas, agua, medicaci√≥n y estado de √°nimo)
  </em>
</div>


    <!-- Datos generales -->
    <div class="card">
      <h2>üìÖ Datos del turno</h2>
      <div class="two-cols">
        <div class="row">
          <label for="fecha">Fecha</label>
          <input type="date" id="fecha">
        </div>
        <div class="row">
          <label for="turno">Turno</label>
          <select id="turno">
            <option value="maniana">Ma√±ana</option>
            <option value="tarde">Tarde</option>
            <option value="noche">Noche</option>
            <option value="completo">24 hs</option>
          </select>
        </div>
      </div>
      <div class="row">
        <label for="cuidador">Cuidadora</label>
        <select id="cuidador">
          <option value="guadalupe">Guadalupe</option>
          <option value="aylen">Ayl√©n</option>
          <option value="noelia">Noelia</option>
          <option value="rocio">Roc√≠o</option>
          <option value="otro">Familiar / Otro</option>
        </select>
      </div>
      <div class="small-text" id="suggestInfo"></div>
      <div class="saved-message" id="savedMessage"></div>
    </div>

    <!-- Comidas -->
    <div class="card">
      <h2>
        üç≥‚Äã Comidas del d√≠a
        <span id="statusComidas" class="status-pill"></span>
      </h2>
      <div class="checkbox-grid">
        <label class="checkbox-item">
          <input type="checkbox" id="desayuno">
          <span>Desayuno</span>
        </label>
        <label class="checkbox-item">
          <input type="checkbox" id="almuerzo">
          <span>Almuerzo</span>
        </label>
        <label class="checkbox-item">
          <input type="checkbox" id="merienda">
          <span>Merienda</span>
        </label>
        <label class="checkbox-item">
          <input type="checkbox" id="cena">
          <span>Cena</span>
        </label>
      </div>
      <div class="small-text">Tildar en el turno en el que se realiza cada comida.</div>
    </div>

    <!-- Agua -->
    <div class="card">
      <h2>üíß Agua (por turno)</h2>
      <div class="row">
        <label for="aguaVasos">Vasos tomados en el d√≠a</label>
        <input type="number" id="aguaVasos" min="0" max="40" step="1" inputmode="numeric">
      </div>
      <div class="small-text">Actualizar a lo largo del d√≠a. Se consolida entre turnos.</div>
    </div>

    <!-- Medicaci√≥n -->
    <div class="card">
      <h2>
        üíä Medicaci√≥n del d√≠a
        <span id="statusMed" class="status-pill"></span>
      </h2>
      <div class="checkbox-grid">
        <label class="checkbox-item">
          <input type="checkbox" id="medManiana">
          <span>Ma√±ana</span>
        </label>
        <label class="checkbox-item">
          <input type="checkbox" id="medNoche">
          <span>Noche</span>
        </label>
      </div>
      <div class="small-text">
        La pastilla de la ma√±ana y de la noche deben estar marcadas para considerar el d√≠a completo.
      </div>
    </div>

    <!-- Estado de √°nimo -->
    <div class="card">
      <h2>Estado de √°nimo (turno)</h2>
      <div class="mood-group">
        <label class="mood-option">
          <input type="radio" name="estadoAnimo" value="bien">
          <span class="mood-emoji">üôÇ</span>
          <span class="mood-label">Bien</span>
        </label>
        <label class="mood-option">
          <input type="radio" name="estadoAnimo" value="neutral">
          <span class="mood-emoji">üòê</span>
          <span class="mood-label">Normal</span>
        </label>
        <label class="mood-option">
          <input type="radio" name="estadoAnimo" value="mal">
          <span class="mood-emoji">üòü</span>
          <span class="mood-label">Mal</span>
        </label>
      </div>
      <div class="small-text">Elegir el estado de √°nimo predominante en este turno.</div>
    </div>

    <!-- Notas -->
    <div class="card">
      <h2>üìù Notas del turno</h2>
      <div class="row">
        <label for="notas">Observaciones</label>
        <textarea id="notas" placeholder="Ej: comi√≥ poco, se quej√≥ de dolor, durmi√≥ bien/mal, etc."></textarea>
      </div>
      <button class="reset-btn" id="resetDia">Borrar registro de este turno</button>
    </div>

    <!-- Estado general d√≠a -->
    <div class="card">
      <h2>Resumen r√°pido del d√≠a</h2>
      <div id="resumenTexto" class="small-text"></div>
    </div>

    <!-- Historial -->
    <div class="card">
      <h2>Historial reciente</h2>
      <div class="small-text">
        Ver √∫ltimos turnos registrados. Toc√° un √≠tem para cargarlo en el formulario.<br>
        El resumen se consolida por d√≠a (comidas, medicaci√≥n y agua).
      </div>
      <div id="historialLista" class="history-list"></div>
    </div>

    <!-- Calendario de turnos -->
    <div class="card">
      <h2>üóìÔ∏è‚Äã Calendario de turnos</h2>
      <div class="small-text">Referencia seg√∫n el cronograma acordado.</div>
      <table class="schedule-table">
  <thead>
    <tr>
      <th>D√≠a</th>
      <th>Horarios y cuidadores</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Lunes</td>
      <td>
        12:00 a 18:00 ‚Äî <strong>GUADA</strong><br>
        20:00 a 08:00 ‚Äî <strong>NOELIA</strong> <small>(hasta el martes)</small>
      </td>
    </tr>
    <tr>
      <td>Martes</td>
      <td>
        12:00 a 16:00 ‚Äî <strong>AYL√âN</strong><br>
        21:00 a 12:00 ‚Äî <strong>GUADA</strong> <small>(hasta el mi√©rcoles)</small>
      </td>
    </tr>
    <tr>
      <td>Mi√©rcoles</td>
      <td>
        12:00 a 18:00 ‚Äî <strong>GUADA</strong><br>
        20:00 a 08:00 ‚Äî <strong>NOELIA</strong> <small>(hasta el jueves)</small>
      </td>
    </tr>
    <tr>
      <td>Jueves</td>
      <td>
        12:00 a 16:00 ‚Äî <strong>AYL√âN</strong><br>
        20:00 a 08:00 ‚Äî <strong>NOELIA</strong> <small>(hasta el viernes)</small>
      </td>
    </tr>
    <tr>
      <td>Viernes</td>
      <td>
        09:00 a 18:00 ‚Äî <strong>GUADA</strong><br>
        20:00 a 08:00 ‚Äî <strong>NOELIA</strong> <small>(hasta el s√°bado)</small>
      </td>
    </tr>
    <tr>
      <td>S√°bado</td>
      <td>
        20:00 a 08:00 ‚Äî <strong>ROC√çO</strong> <small>(hasta el domingo)</small>
      </td>
    </tr>
    <tr>
      <td>Domingo</td>
      <td>
        19:00 a 08:00 ‚Äî <strong>ROC√çO</strong> <small>(hasta el lunes)</small>
      </td>
    </tr>
  </tbody>
</table>

    </div>

    <!-- Exportar (al fondo) -->
    <div class="card">
      <h2>Exportar registros</h2>
      <button class="export-btn" id="exportDia">‚¨áÔ∏è Exportar d√≠a a Excel / Sheets</button>
      <div class="small-text">Genera un CSV con todos los turnos del d√≠a seleccionado.</div>
    </div>

    <div class="footer-info">
      Developed by Cundo.NET
    </div>
  </div>

  <script>
    const API_BASE = "/api";

    async function apiGuardar(record) {
      const res = await fetch(API_BASE + "/guardar-registro", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(record)
      });
      if (!res.ok) throw new Error("Error al guardar registro");
      try { return await res.json(); } catch { return {}; }
    }

    async function apiListar(params = {}) {
      const url = new URL(API_BASE + "/listar-registros", window.location.origin);
      Object.entries(params).forEach(([k, v]) => {
        if (v !== undefined && v !== null && v !== "") {
          url.searchParams.set(k, v);
        }
      });
      const res = await fetch(url.toString());
      if (!res.ok) throw new Error("Error al leer registros");
      return await res.json();
    }

    const fechaInput       = document.getElementById("fecha");
    const turnoSelect      = document.getElementById("turno");
    const cuidadorSelect   = document.getElementById("cuidador");
    const desayunoInput    = document.getElementById("desayuno");
    const almuerzoInput    = document.getElementById("almuerzo");
    const meriendaInput    = document.getElementById("merienda");
    const cenaInput        = document.getElementById("cena");
    const aguaInput        = document.getElementById("aguaVasos");
    const medManianaInput  = document.getElementById("medManiana");
    const medNocheInput    = document.getElementById("medNoche");
    const notasInput       = document.getElementById("notas");
    const statusComidas    = document.getElementById("statusComidas");
    const statusMed        = document.getElementById("statusMed");
    const resumenTexto     = document.getElementById("resumenTexto");
    const savedMessage     = document.getElementById("savedMessage");
    const resetDiaBtn      = document.getElementById("resetDia");
    const historialLista   = document.getElementById("historialLista");
    const suggestInfo      = document.getElementById("suggestInfo");
    const exportDiaBtn     = document.getElementById("exportDia");

    const moodOptions      = document.querySelectorAll(".mood-option");
    const moodRadios       = document.querySelectorAll('input[name="estadoAnimo"]');

    let saveTimeout = null;
    let lastCuidadorValue = cuidadorSelect.value;

 
async function apiBorrar(id) {
  const url = new URL(API_BASE + "/borrar-registro", window.location.origin);
  url.searchParams.set("id", id);
  const res = await fetch(url.toString(), { method: "POST" });
  if (!res.ok) throw new Error("Error al borrar registro");
  return await res.json();
}
   const schedule = {
      1: [
        { from: 0,        to: 8 * 60,  cuidador: "rocio"     },
        { from: 12 * 60,  to: 18 * 60, cuidador: "guadalupe" },
        { from: 20 * 60,  to: 24 * 60, cuidador: "noelia"    }
      ],
      2: [
        { from: 0,        to: 8 * 60,  cuidador: "noelia"    },
        { from: 12 * 60,  to: 16 * 60, cuidador: "aylen"     },
        { from: 21 * 60,  to: 24 * 60, cuidador: "guadalupe" }
      ],
      3: [
        { from: 0,        to: 12 * 60, cuidador: "guadalupe" },
        { from: 12 * 60,  to: 18 * 60, cuidador: "guadalupe" },
        { from: 20 * 60,  to: 24 * 60, cuidador: "noelia"    }
      ],
      4: [
        { from: 0,        to: 8 * 60,  cuidador: "noelia"    },
        { from: 12 * 60,  to: 16 * 60, cuidador: "aylen"     },
        { from: 20 * 60,  to: 24 * 60, cuidador: "noelia"    }
      ],
      5: [
        { from: 0,        to: 8 * 60,  cuidador: "noelia"    },
        { from: 9 * 60,   to: 18 * 60, cuidador: "guadalupe" },
        { from: 20 * 60,  to: 24 * 60, cuidador: "noelia"    }
      ],
      6: [
        { from: 0,        to: 8 * 60,  cuidador: "noelia"    },
        { from: 20 * 60,  to: 24 * 60, cuidador: "rocio"     }
      ],
      0: [
        { from: 0,        to: 8 * 60,  cuidador: "rocio"     },
        { from: 19 * 60,  to: 24 * 60, cuidador: "rocio"     }
      ]
    };

    function hoyISO() {
      const hoy = new Date();
      const y = hoy.getFullYear();
      const m = String(hoy.getMonth() + 1).padStart(2, "0");
      const d = String(hoy.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function getNowInfo() {
      const now = new Date();
      const dow = now.getDay();
      const minutes = now.getHours() * 60 + now.getMinutes();
      return { dow, minutes };
    }

    function getCaregiverFor(dow, minutes) {
      const daySched = schedule[dow] || [];
      for (const slot of daySched) {
        if (minutes >= slot.from && minutes < slot.to) return slot.cuidador;
      }
      return null;
    }

    function getScheduledCuidadorForFechaTurno(fechaStr, turno) {
      const base = fechaStr || hoyISO();
      const fecha = new Date(base + "T12:00:00");
      const dow = fecha.getDay();

      let minutes;
      switch (turno) {
        case "maniana":
          minutes = 9 * 60;
          break;
        case "tarde":
          minutes = 15 * 60;
          break;
        case "noche":
          minutes = 22 * 60;
          break;
        case "completo":
        default:
          minutes = 12 * 60;
      }
      return getCaregiverFor(dow, minutes);
    }

    function guessTurnoFromMinutes(minutes) {
      if (minutes >= 6 * 60 && minutes < 12 * 60) return "maniana";
      if (minutes >= 12 * 60 && minutes < 20 * 60) return "tarde";
      return "noche";
    }

    function getSelectedMood() {
      let value = "";
      moodRadios.forEach(r => { if (r.checked) value = r.value; });
      return value;
    }

    function setMoodUI(value) {
      moodOptions.forEach(opt => {
        const radio = opt.querySelector('input[name="estadoAnimo"]');
        const match = radio.value === value;
        radio.checked = match;
        opt.classList.toggle("selected", match);
      });
    }

    function clearMoodUI() {
      setMoodUI("");
    }

    function moodEmoji(value) {
      if (value === "bien") return "üôÇ";
      if (value === "neutral") return "üòê";
      if (value === "mal") return "üòü";
      return "";
    }

    function labelCuidador(value) {
      switch (value) {
        case "guadalupe": return "Guadalupe";
        case "aylen":     return "Ayl√©n";
        case "noelia":    return "Noelia";
        case "rocio":     return "Roc√≠o";
        case "otro":      return "Familiar / Otro";
        default:          return value;
      }
    }

    function labelTurno(value) {
      switch (value) {
        case "maniana": return "Ma√±ana";
        case "tarde":   return "Tarde";
        case "noche":   return "Noche";
        case "completo":return "24 hs";
        default:        return value || "-";
      }
    }

    function formatFecha(fechaStr) {
      if (!fechaStr) return "-";
      const base = fechaStr.slice(0, 10);
      const [y, m, d] = base.split("-");
      if (!y || !m || !d) return fechaStr;
      return `${d}/${m}/${y}`;
    }

    function mostrarGuardado() {
      savedMessage.textContent = "Guardado en TERE ‚úÖ";
      if (saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => { savedMessage.textContent = ""; }, 1500);
    }

    async function fetchRecordForCurrentKey() {
      const fecha = fechaInput.value || hoyISO();
      const cuidador = cuidadorSelect.value;
      const turno = turnoSelect.value;

      const rows = await apiListar({ fecha, cuidador, turno });
      if (!rows || rows.length === 0) return null;

      const r = rows[0];

      return {
        fecha,
        turno,
        cuidador,
        desayuno: !!r.desayuno,
        almuerzo: !!r.almuerzo,
        merienda: !!r.merienda,
        cena: !!r.cena,
        aguaVasos: r.agua_vasos ?? 0,
        medManiana: !!r.med_maniana,
        medNoche: !!r.med_noche,
        notas: r.notas || "",
        estadoAnimo: r.estado_animo || ""
      };
    }

    async function getDailySummary(fechaStr) {
      const registros = await apiListar({ fecha: fechaStr });

      const result = {
        desayuno: false,
        almuerzo: false,
        merienda: false,
        cena: false,
        medManiana: false,
        medNoche: false,
        aguaVasos: 0,
        turnos: 0
      };

      registros.forEach(rec => {
        result.turnos += 1;
        if (rec.desayuno)      result.desayuno = true;
        if (rec.almuerzo)      result.almuerzo = true;
        if (rec.merienda)      result.merienda = true;
        if (rec.cena)          result.cena = true;
        if (rec.med_maniana)   result.medManiana = true;
        if (rec.med_noche)     result.medNoche = true;
        const agua = rec.agua_vasos || 0;
        if (agua > result.aguaVasos) result.aguaVasos = agua;
      });

      return result;
    }

    async function saveCurrentRecord() {
      const record = {
        fecha: fechaInput.value || hoyISO(),
        turno: turnoSelect.value,
        cuidador: cuidadorSelect.value,
        desayuno: desayunoInput.checked,
        almuerzo: almuerzoInput.checked,
        merienda: meriendaInput.checked,
        cena: cenaInput.checked,
        aguaVasos: parseInt(aguaInput.value || "0", 10),
        medManiana: medManianaInput.checked,
        medNoche: medNocheInput.checked,
        notas: notasInput.value || "",
        estadoAnimo: getSelectedMood()
      };

      try {
        await apiGuardar(record);
        mostrarGuardado();
        await actualizarEstadosVisuales();
        await buildHistory();
      } catch (e) {
        console.error(e);
        alert("No se pudo guardar en la base central. Revisar conexi√≥n.");
      }
    }

    async function loadCurrentRecord() {
      try {
        const rec = await fetchRecordForCurrentKey();
        if (rec) {
          desayunoInput.checked   = rec.desayuno;
          almuerzoInput.checked   = rec.almuerzo;
          meriendaInput.checked   = rec.merienda;
          cenaInput.checked       = rec.cena;
          aguaInput.value         = rec.aguaVasos || "";
          medManianaInput.checked = rec.medManiana;
          medNocheInput.checked   = rec.medNoche;
          notasInput.value        = rec.notas || "";
          setMoodUI(rec.estadoAnimo);
        } else {
          desayunoInput.checked   = false;
          almuerzoInput.checked   = false;
          meriendaInput.checked   = false;
          cenaInput.checked       = false;
          aguaInput.value         = "";
          medManianaInput.checked = false;
          medNocheInput.checked   = false;
          notasInput.value        = "";
          clearMoodUI();
        }
        await actualizarEstadosVisuales();
        savedMessage.textContent = "";
      } catch (e) {
        console.error(e);
      }
    }

    async function resetCurrentRecord() {
      desayunoInput.checked   = false;
      almuerzoInput.checked   = false;
      meriendaInput.checked   = false;
      cenaInput.checked       = false;
      aguaInput.value         = "";
      medManianaInput.checked = false;
      medNocheInput.checked   = false;
      notasInput.value        = "";
      clearMoodUI();
      await saveCurrentRecord();
    }

    async function actualizarEstadosVisuales() {
      const anyMeal = desayunoInput.checked || almuerzoInput.checked ||
                      meriendaInput.checked || cenaInput.checked;
      const allMeals = desayunoInput.checked && almuerzoInput.checked &&
                       meriendaInput.checked && cenaInput.checked;

      if (allMeals) {
        statusComidas.textContent = "Comidas completas (turno)";
        statusComidas.classList.add("status-ok");
        statusComidas.classList.remove("status-pending");
      } else if (anyMeal) {
        statusComidas.textContent = "Comidas incompletas (turno)";
        statusComidas.classList.add("status-pending");
        statusComidas.classList.remove("status-ok");
      } else {
        statusComidas.textContent = "Sin comidas registradas en este turno";
        statusComidas.classList.add("status-pending");
        statusComidas.classList.remove("status-ok");
      }

      const medAny = medManianaInput.checked || medNocheInput.checked;
      const medAll = medManianaInput.checked && medNocheInput.checked;

      if (medAll) {
        statusMed.textContent = "Medicaci√≥n completa (turno)";
        statusMed.classList.add("status-ok");
        statusMed.classList.remove("status-pending");
      } else if (medAny) {
        statusMed.textContent = "Medicaci√≥n incompleta (turno)";
        statusMed.classList.add("status-pending");
        statusMed.classList.remove("status-ok");
      } else {
        statusMed.textContent = "Sin medicaci√≥n registrada en este turno";
        statusMed.classList.add("status-pending");
        statusMed.classList.remove("status-ok");
      }

      const fechaDia = fechaInput.value || hoyISO();
      try {
        const daily = await getDailySummary(fechaDia);
        const partes = [];

        const todasComidasDia = daily.desayuno && daily.almuerzo &&
                                daily.merienda && daily.cena;

        if (todasComidasDia) {
          partes.push("‚úÖ Todas las comidas del d√≠a registradas (desayuno, almuerzo, merienda y cena).");
        } else {
          const faltantes = [];
          if (!daily.desayuno) faltantes.push("desayuno");
          if (!daily.almuerzo) faltantes.push("almuerzo");
          if (!daily.merienda) faltantes.push("merienda");
          if (!daily.cena) faltantes.push("cena");
          partes.push(`‚ö†Ô∏è Faltan comidas por registrar: ${faltantes.join(", ")}.`);
        }

        if (daily.medManiana && daily.medNoche) {
          partes.push("‚úÖ Medicaci√≥n del d√≠a completa (ma√±ana y noche registradas en al menos un turno).");
        } else if (daily.medManiana || daily.medNoche) {
          partes.push("‚ö†Ô∏è Medicaci√≥n incompleta (s√≥lo una franja registrada).");
        } else {
          partes.push("‚ö†Ô∏è No se registr√≥ medicaci√≥n para este d√≠a.");
        }

        const vasos = daily.aguaVasos || 0;
        if (vasos > 0) {
          partes.push(`üíß Se registraron ${vasos} vaso(s) de agua en el d√≠a (valor consolidado).`);
        } else {
          partes.push("üíß No se registr√≥ agua para este d√≠a.");
        }

        if (daily.turnos > 0) {
          partes.push(`üìã Turnos registrados en el d√≠a: ${daily.turnos}.`);
        } else {
          partes.push("üìã A√∫n no hay turnos registrados para este d√≠a.");
        }

        resumenTexto.textContent = partes.join(" ");
      } catch (e) {
        console.error(e);
        resumenTexto.textContent = "No se pudo obtener el resumen diario (problema de conexi√≥n).";
      }
    }

    async function buildHistory() {
      try {
        const registros = await apiListar({ limite: 100 });

        if (!registros || registros.length === 0) {
          historialLista.innerHTML = "<div class='small-text'>Sin registros todav√≠a.</div>";
          return;
        }

        const agrupados = new Map();

        registros.forEach(rec => {
          const fechaStr = typeof rec.fecha === "string" ? rec.fecha.slice(0, 10) : rec.fecha;
          const key = `${fechaStr}|${rec.turno}|${rec.cuidador}`;
          if (!agrupados.has(key)) {
            agrupados.set(key, rec);
          }
        });

        const condensados = Array.from(agrupados.values());
        historialLista.innerHTML = "";

        condensados.forEach(rec => {
          const fechaStr  = typeof rec.fecha === "string" ? rec.fecha.slice(0, 10) : rec.fecha;
          const comidasCount =
            (rec.desayuno ? 1 : 0) +
            (rec.almuerzo ? 1 : 0) +
            (rec.merienda ? 1 : 0) +
            (rec.cena ? 1 : 0);

          const medCount =
            (rec.med_maniana ? 1 : 0) +
            (rec.med_noche ? 1 : 0);

          const agua = rec.agua_vasos ?? 0;
          const mood = moodEmoji(rec.estado_animo);

          const item   = document.createElement("div");
          item.className = "history-item";

          const main  = document.createElement("div");
          main.className = "history-item-main";

          const title = document.createElement("div");
          title.className = "history-title";
          title.textContent = `${formatFecha(fechaStr)} ¬∑ ${labelTurno(rec.turno)}${mood ? " " + mood : ""}`;

          const badge = document.createElement("div");
          badge.className = "badge";
          badge.textContent = labelCuidador(rec.cuidador);

          main.appendChild(title);
          main.appendChild(badge);

          const meta = document.createElement("div");
          meta.className = "history-meta";
          meta.textContent = rec.notas
            ? `Notas: ${rec.notas.slice(0, 60)}${rec.notas.length > 60 ? "..." : ""}`
            : "Sin notas.";

          const summary = document.createElement("div");
          summary.className = "history-summary";
          summary.textContent =
            `Comidas: ${comidasCount}/4 ¬∑ Med: ${medCount}/2 ¬∑ Agua: ${agua} vaso(s)`;

          item.appendChild(main);
          item.appendChild(summary);
			  // Bot√≥n de borrado
  const deleteBtn = document.createElement("button");
  deleteBtn.className = "delete-button";
  deleteBtn.textContent = "Borrar";
  deleteBtn.addEventListener("click", async (e) => {
    e.stopPropagation();
    try {
      await apiBorrar(rec.id);
      await buildHistory();
    } catch (err) {
      console.error(err);
    }
  });
  item.appendChild(deleteBtn);

          item.appendChild(meta);

          item.addEventListener("click", () => {
            fechaInput.value     = fechaStr || hoyISO();
            turnoSelect.value    = rec.turno || "maniana";
            cuidadorSelect.value = rec.cuidador || "otro";
            lastCuidadorValue    = cuidadorSelect.value;
            suggestInfo.textContent = "";
            loadCurrentRecord();
            window.scrollTo({ top: 0, behavior: "smooth" });
          });

          historialLista.appendChild(item);
        });
      } catch (e) {
        console.error(e);
        historialLista.innerHTML = "<div class='small-text'>No se pudo cargar el historial (problema de conexi√≥n).</div>";
      }
    }

    function sugerirTurnoYCuidadorSegunAhora() {
      const hoy = hoyISO();
      fechaInput.value = hoy;

      const { minutes } = getNowInfo();
      const turnoGuess = guessTurnoFromMinutes(minutes);
      turnoSelect.value = turnoGuess;

      const scheduled = getScheduledCuidadorForFechaTurno(hoy, turnoGuess);

      if (scheduled) {
        cuidadorSelect.value = scheduled;
        suggestInfo.textContent = "Cuidadora sugerida autom√°ticamente seg√∫n calendario del turno.";
      } else {
        suggestInfo.textContent = "Fuera de un turno fijo: seleccionar cuidadora manualmente.";
      }

      lastCuidadorValue = cuidadorSelect.value;
    }

    async function handleCuidadorChange() {
      const newValue = cuidadorSelect.value;
      const fechaSel = fechaInput.value || hoyISO();
      const turnoSel = turnoSelect.value;

      const scheduled = getScheduledCuidadorForFechaTurno(fechaSel, turnoSel);

      if (scheduled && newValue !== "otro" && newValue !== scheduled) {
        const nombreProgramado = labelCuidador(scheduled);
        const nombreNuevo      = labelCuidador(newValue);
        const ok = window.confirm(
          `${nombreNuevo} no est√° programada para este turno.\n` +
          `Seg√∫n el calendario deber√≠a estar ${nombreProgramado}.\n\n` +
          `¬øConfirm√°s que ${nombreNuevo} est√° cubriendo el turno?`
        );
        if (!ok) {
          cuidadorSelect.value = lastCuidadorValue;
          return;
        }
      }

      lastCuidadorValue = newValue;
      suggestInfo.textContent = "";
      await loadCurrentRecord();
    }
	  

    async function init() {
      sugerirTurnoYCuidadorSegunAhora();
      await loadCurrentRecord();
      await buildHistory();

      fechaInput.addEventListener("change", () => {
        suggestInfo.textContent = "";
        loadCurrentRecord();
      });

      turnoSelect.addEventListener("change", () => {
        loadCurrentRecord();
      });

      cuidadorSelect.addEventListener("change", () => {
        handleCuidadorChange();
      });

      [
        desayunoInput,
        almuerzoInput,
        meriendaInput,
        cenaInput,
        medManianaInput,
        medNocheInput
      ].forEach(el => el.addEventListener("change", () => { saveCurrentRecord(); }));

      aguaInput.addEventListener("input", () => { saveCurrentRecord(); });
      notasInput.addEventListener("input", () => { saveCurrentRecord(); });

      moodOptions.forEach(opt => {
        const radio = opt.querySelector('input[name="estadoAnimo"]');
        opt.addEventListener("click", () => {
          setMoodUI(radio.value);
          saveCurrentRecord();
        });
      });

      resetDiaBtn.addEventListener("click", () => { resetCurrentRecord(); });

      exportDiaBtn.addEventListener("click", () => {
        const fecha = fechaInput.value || hoyISO();
        const url = `${API_BASE}/exportar-csv?fecha=${encodeURIComponent(fecha)}`;
        window.open(url, "_blank");
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      init();
    });
  </script>
</body>
</html>



